–ü–ê–ü–ö–ê CONFIG
========================

AppConfig.cs
=====

// Config/AppConfig.cs - –ü–û–í–ù–ò–ô –ö–û–î –î–õ–Ø –í–ê–†–Ü–ê–ù–¢–£ 3
namespace TrackingApp.Config
{
    public static class AppConfig
    {
        // –†–µ–∂–∏–º —Ä–æ–±–æ—Ç–∏: Local (–º–æ–∫-–¥–∞–Ω—ñ) –∞–±–æ Server (—Ä–µ–∞–ª—å–Ω–∏–π —Å–µ—Ä–≤–µ—Ä)
        public static bool UseServerMode { get; set; } = true;

        // TCP –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è (–∑–∞–º—ñ—Å—Ç—å HTTP)
        public static string ServerHost { get; set; } = "localhost";
        public static int ServerPort { get; set; } = 8888;

        // –¢–∞–π–º–∞—É—Ç–∏ –¥–ª—è –∑–∞–ø–∏—Ç—ñ–≤
        public static int RequestTimeoutSeconds { get; set; } = 10;

        // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É
        public static string LocalDataFile { get; set; } = "local_data.json";

        // –ú–µ—Ç–æ–¥ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
        public static void LogConfiguration()
        {
            System.Diagnostics.Debug.WriteLine("=== –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø –ö–õ–Ü–Ñ–ù–¢–ê ===");
            System.Diagnostics.Debug.WriteLine($"UseServerMode: {UseServerMode}");
            System.Diagnostics.Debug.WriteLine($"TCP Server: {ServerHost}:{ServerPort}");
            System.Diagnostics.Debug.WriteLine($"RequestTimeout: {RequestTimeoutSeconds}s");
            System.Diagnostics.Debug.WriteLine($"LocalDataFile: {LocalDataFile}");
            System.Diagnostics.Debug.WriteLine("===========================");
        }
    }
}



--------------------------------------------------------------------


–ü–ê–ü–ö–ê CONVERTERS
==============================

BooleanToVisibilityConverter.cs
=====


using System;
using System.Windows;
using System.Windows.Data;

namespace TrackingApp.Converters
{
    public class BooleanToVisibilityConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, System.Globalization.CultureInfo culture)
        {
            return (value is bool && (bool)value) ? Visibility.Visible : Visibility.Collapsed;
        }

        public object ConvertBack(object value, Type targetType, object parameter, System.Globalization.CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }
}




---------------------------------------------------------------


BoolToBrushConverter.cs
=====


using System;
using System.Globalization;
using System.Windows.Data;
using System.Windows.Media;

namespace TrackingApp.Converters
{
    public class BoolToBrushConverter : IValueConverter
    {
        public Brush? LeaderBrush { get; set; } = Brushes.Red;
        public Brush? DefaultBrush { get; set; } = Brushes.Green;

        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value is bool b && b)
                return LeaderBrush ?? Brushes.Red;
            return DefaultBrush ?? Brushes.Green;
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture) => throw new NotImplementedException();
    }
}




------------------------------------------------------------------------------



–ü–ê–ü–ö–ê Infrastructure
==========================


// Infrastructure/HttpClientFactory.cs
using TrackingApp.Config;
using TrackingApp.Infrastructure;

public static class HttpClientFactory
{
    public static IHttpClient CreateClient()
    {
        return AppConfig.UseServerMode
            ? new TcpClientService()  // –ó–º—ñ–Ω–∏—Ç–∏ –Ω–∞ TCP –∫–ª—ñ—î–Ω—Ç!
            : new LocalHttpClient();
    }
}



----------------------------------------------------------------------------



IHttpClient.cs
====



using System.Threading.Tasks;

namespace TrackingApp.Infrastructure
{
    public interface IHttpClient
    {
        Task<T> GetAsync<T>(string endpoint);
        Task<T> PostAsync<T>(string endpoint, object data);
        Task<T> PutAsync<T>(string endpoint, object data);
        Task<bool> DeleteAsync(string endpoint);
    }
}



---------------------------------------------------------------------



LocalHttpClient.cs
===


using System;
using System.Threading.Tasks;
using System.Linq;
using TrackingApp.Config;
using TrackingApp.Services;
using TrackingApp.Models;

namespace TrackingApp.Infrastructure
{
    public class LocalHttpClient : IHttpClient
    {
        private readonly LocalDataService _localData;

        public LocalHttpClient()
        {
            _localData = new LocalDataService();
        }

        public async Task<T> GetAsync<T>(string endpoint)
        {
            // –Ü–º—ñ—Ç–∞—Ü—ñ—è –º–µ—Ä–µ–∂–µ–≤–æ—ó –∑–∞—Ç—Ä–∏–º–∫–∏
            await Task.Delay(new Random().Next(50, 200));

            try
            {
                object result = endpoint switch
                {
                    "/api/users" => _localData.GetUsers(),
                    "/api/trip/current" => _localData.GetCurrentTrip(),
                    "/api/notifications" => _localData.GetNotifications(),
                    _ => throw new ArgumentException($"Unknown endpoint: {endpoint}")
                };

                // –°—Ç–≤–æ—Ä—é—î–º–æ —É—Å–ø—ñ—à–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å
                var response = new ApiResponse<object>
                {
                    Success = true,
                    Message = "Success",
                    Data = result
                };

                return (T)Convert.ChangeType(response, typeof(T));
            }
            catch (Exception ex)
            {
                // –°—Ç–≤–æ—Ä—é—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∑ –ø–æ–º–∏–ª–∫–æ—é
                var response = new ApiResponse<object>
                {
                    Success = false,
                    Message = ex.Message,
                    Data = null,
                    ErrorCode = "LOCAL_ERROR"
                };

                return (T)Convert.ChangeType(response, typeof(T));
            }
        }

        public async Task<T> PostAsync<T>(string endpoint, object data)
        {
            await Task.Delay(new Random().Next(100, 300));

            try
            {
                // –û–±—Ä–æ–±–∫–∞ —Ä—ñ–∑–Ω–∏—Ö endpoint'—ñ–≤
                switch (endpoint)
                {
                    case "/api/notifications":
                        if (data is Notification notification)
                        {
                            _localData.AddNotification(notification);
                        }
                        break;
                    case "/api/auth/register":
                        // –õ–æ–≥—ñ–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
                        break;
                }

                var response = new ApiResponse<bool>
                {
                    Success = true,
                    Message = "Operation completed",
                    Data = true
                };

                return (T)Convert.ChangeType(response, typeof(T));
            }
            catch (Exception ex)
            {
                var response = new ApiResponse<bool>
                {
                    Success = false,
                    Message = ex.Message,
                    Data = false
                };

                return (T)Convert.ChangeType(response, typeof(T));
            }
        }

        public async Task<T> PutAsync<T>(string endpoint, object data)
        {
            await Task.Delay(new Random().Next(100, 300));

            try
            {
                // –û–±—Ä–æ–±–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω—å
                switch (endpoint)
                {
                    case "/api/trip":
                        if (data is Trip trip)
                        {
                            _localData.UpdateTrip(trip);
                        }
                        break;
                    case string s when s.StartsWith("/api/users/") && s.EndsWith("/location"):
                        if (data is Location location)
                        {
                            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
                            var userId = endpoint.Split('/')[3];
                            var users = _localData.GetUsers();
                            var user = users.FirstOrDefault(u => u.Id == userId);
                            if (user != null)
                            {
                                user.CurrentLocation = location;
                                _localData.SaveUser(user);
                            }
                        }
                        break;
                }

                var response = new ApiResponse<bool>
                {
                    Success = true,
                    Message = "Update completed",
                    Data = true
                };

                return (T)Convert.ChangeType(response, typeof(T));
            }
            catch (Exception ex)
            {
                var response = new ApiResponse<bool>
                {
                    Success = false,
                    Message = ex.Message,
                    Data = false
                };

                return (T)Convert.ChangeType(response, typeof(T));
            }
        }

        public async Task<bool> DeleteAsync(string endpoint)
        {
            await Task.Delay(new Random().Next(100, 300));
            return true;
        }
    }
}




------------------------------------------------------------------------


TcpClientService.cs
===



// Infrastructure/TcpClientService.cs
using System;
using System.IO;
using System.Net.Sockets;
using System.Text;
using System.Text.Json;
using System.Threading.Tasks;
using TrackingApp.Config;
using TrackingApp.Services;

namespace TrackingApp.Infrastructure
{
    public class TcpClientService : IHttpClient
    {
        private readonly JsonSerializerOptions _jsonOptions;

        public TcpClientService()
        {
            _jsonOptions = new JsonSerializerOptions
            {
                PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
                WriteIndented = true
            };
        }

        private string GetCommandFromEndpoint(string endpoint, string method)
        {
            var endpointLower = endpoint.ToLower();

            System.Diagnostics.Debug.WriteLine($"üîç GetCommandFromEndpoint: {endpoint}, –º–µ—Ç–æ–¥: {method}");

            if (endpointLower == "/api/ping") return "ping";
            if (endpointLower == "/api/users") return "get_users";
            if (endpointLower == "/api/trip/current") return "get_active_trip";
            if (endpointLower == "/api/trip/active") return "get_active_trip";
            if (endpointLower == "/api/notifications")
                return method == "GET" ? "get_notifications" : "add_notification";
            if (endpointLower.StartsWith("/api/users/") && endpointLower.EndsWith("/location"))
                return "update_location";
            if (endpointLower == "/api/statistics")
                return "get_statistics";
            if (endpointLower == "/api/auth/register")
                return "register_user";
            if (endpointLower == "/api/auth/login")
                return "get_users";
            if (endpointLower == "/api/feedback")
                return "add_feedback";
            if (endpointLower == "/api/trips/predefined")
                return "get_predefined_trips";
            if (endpointLower == "/api/trips/set_active")
                return "set_active_trip";
            if (endpointLower == "/api/trips/save_predefined")
                return "save_predefined_trip";

            // –î–û–î–ê–ù–û: –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–ª–∞–Ω—É –ø–æ–¥–æ—Ä–æ–∂—ñ
            if (endpointLower == "/api/trip/plan/update")
                return "update_trip_plan";

            System.Diagnostics.Debug.WriteLine($"‚ö†Ô∏è –ù–µ–≤—ñ–¥–æ–º–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è: {endpoint}, –º–µ—Ç–æ–¥: {method}");
            return "unknown";
        }

        public async Task<T> GetAsync<T>(string endpoint)
        {
            try
            {
                var command = GetCommandFromEndpoint(endpoint, "GET");
                var request = new { Command = command, Data = new { } };
                return await SendTcpRequest<T>(request);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ GetAsync –¥–ª—è {endpoint}: {ex.Message}");
                throw;
            }
        }

        public async Task<T> PostAsync<T>(string endpoint, object data)
        {
            try
            {
                var command = GetCommandFromEndpoint(endpoint, "POST");
                var request = new { Command = command, Data = data };
                return await SendTcpRequest<T>(request);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ PostAsync –¥–ª—è {endpoint}: {ex.Message}");
                throw;
            }
        }

        public async Task<T> PutAsync<T>(string endpoint, object data)
        {
            try
            {
                var command = GetCommandFromEndpoint(endpoint, "PUT");
                var request = new { Command = command, Data = data };
                return await SendTcpRequest<T>(request);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ PutAsync –¥–ª—è {endpoint}: {ex.Message}");
                throw;
            }
        }

        public async Task<bool> DeleteAsync(string endpoint)
        {
            try
            {
                var request = new { Command = "delete", Data = new { endpoint } };
                var result = await SendTcpRequest<object>(request);
                return true;
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ DeleteAsync –¥–ª—è {endpoint}: {ex.Message}");
                return false;
            }
        }

        private async Task<T> SendTcpRequest<T>(object request)
        {
            TcpClient client = null;
            try
            {
                var jsonRequest = JsonSerializer.Serialize(request, _jsonOptions);
                System.Diagnostics.Debug.WriteLine($"üì§ TCP –í–Ü–î–ü–†–ê–í–ö–ê –¥–æ {AppConfig.ServerHost}:{AppConfig.ServerPort}");
                System.Diagnostics.Debug.WriteLine($"üìÑ –ó–∞–ø–∏—Ç: {jsonRequest}");

                client = new TcpClient();

                var encoding = new UTF8Encoding(encoderShouldEmitUTF8Identifier: false);

                var connectTask = client.ConnectAsync(AppConfig.ServerHost, AppConfig.ServerPort);
                var timeoutTask = Task.Delay(TimeSpan.FromSeconds(5));

                var completedTask = await Task.WhenAny(connectTask, timeoutTask);

                if (completedTask == timeoutTask)
                {
                    System.Diagnostics.Debug.WriteLine("‚ùå –¢–ê–ô–ú–ê–£–¢ –ü–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø: –°–µ—Ä–≤–µ—Ä –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –ø—Ä–æ—Ç—è–≥–æ–º 5 —Å–µ–∫—É–Ω–¥");
                    throw new TimeoutException("–°–µ—Ä–≤–µ—Ä –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î");
                }

                if (!client.Connected)
                {
                    System.Diagnostics.Debug.WriteLine("‚ùå –ù–ï –í–î–ê–õ–û–°–Ø –ü–Ü–î–ö–õ–Æ–ß–ò–¢–ò–°–Ø: Client.Connected = false");
                    throw new Exception("–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞");
                }

                System.Diagnostics.Debug.WriteLine("‚úÖ –£–°–ü–Ü–®–ù–û –ü–Ü–î–ö–õ–£–ß–ï–ù–û –î–û –°–ï–†–í–ï–†–ê");

                using var stream = client.GetStream();

                using var writer = new StreamWriter(stream, encoding);
                using var reader = new StreamReader(stream, encoding);

                await writer.WriteAsync(jsonRequest);
                await writer.FlushAsync();

                System.Diagnostics.Debug.WriteLine("‚úÖ –ó–ê–ü–ò–¢ –í–Ü–î–ü–†–ê–í–õ–ï–ù–û");

                var responseJson = await reader.ReadLineAsync();

                if (string.IsNullOrEmpty(responseJson))
                {
                    System.Diagnostics.Debug.WriteLine("‚ùå –û–¢–†–ò–ú–ê–ù–û –ü–£–°–¢–£ –í–Ü–î–ü–û–í–Ü–î–¨");
                    throw new Exception("–°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –ø—É—Å—Ç—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å");
                }

                System.Diagnostics.Debug.WriteLine($"üì• –û–¢–†–ò–ú–ê–ù–û –í–Ü–î–ü–û–í–Ü–î–¨: {responseJson}");

                var apiResponse = JsonSerializer.Deserialize<ApiResponse<T>>(responseJson, _jsonOptions);

                if (apiResponse?.Success == true)
                {
                    System.Diagnostics.Debug.WriteLine($"‚úÖ –ó–ê–ü–ò–¢ –£–°–ü–Ü–®–ù–ò–ô: {apiResponse.Message}");
                    return apiResponse.Data;
                }
                else
                {
                    System.Diagnostics.Debug.WriteLine($"‚ùå –ü–û–ú–ò–õ–ö–ê –í–Ü–î–ü–û–í–Ü–î–Ü: {apiResponse?.Message}");
                    throw new Exception(apiResponse?.Message ?? "–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
                }
            }
            catch (SocketException ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–û–ú–ò–õ–ö–ê SOCKET: {ex.SocketErrorCode} - {ex.Message}");
                throw new Exception($"–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ: {ex.Message}");
            }
            catch (TimeoutException ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –¢–ê–ô–ú–ê–£–¢: {ex.Message}");
                throw new Exception($"–¢–∞–π–º–∞—É—Ç –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è: {ex.Message}");
            }
            catch (JsonException ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–û–ú–ò–õ–ö–ê JSON: {ex.Message}");
                System.Diagnostics.Debug.WriteLine($"üìç –ü–æ–∑–∏—Ü—ñ—è: {ex.BytePositionInLine}, –õ—ñ–Ω—ñ—è: {ex.LineNumber}");
                throw new Exception($"–ü–æ–º–∏–ª–∫–∞ —Ñ–æ—Ä–º–∞—Ç—É –¥–∞–Ω–∏—Ö: {ex.Message}");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ó–ê–ì–ê–õ–¨–ù–ê –ü–û–ú–ò–õ–ö–ê: {ex.Message}");
                System.Diagnostics.Debug.WriteLine($"üìç –¢–∏–ø –ø–æ–º–∏–ª–∫–∏: {ex.GetType().Name}");
                throw;
            }
            finally
            {
                client?.Close();
                client?.Dispose();
            }
        }
    }
}





----------------------------------------------------------------------


–ü–ê–ü–ö–ê Models
===========================


Location.cs
===




namespace TrackingApp.Models
{
    public class Location
    {
        public double Latitude { get; set; }
        public double Longitude { get; set; }

        public Location() { }

        public Location(double lat, double lon)
        {
            Latitude = lat;
            Longitude = lon;
        }

        public override string ToString() => $"{Latitude:F5}, {Longitude:F5}";
    }
}





--------------------------------------------------------------------



Notification.cs
===



using System;

namespace TrackingApp.Models
{
    public class Notification
    {
        public DateTime Time { get; set; } = DateTime.Now;
        public string Message { get; set; } = string.Empty;
        public string UserId { get; set; } = string.Empty;
        public string UserName { get; set; } = string.Empty;
    }
}




---------------------------------------------------------------------



PredefinedTrip.cs
====


using System.Collections.ObjectModel;

namespace TrackingApp.Models
{
    public class PredefinedTrip
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public ObservableCollection<Location> Route { get; set; } = new ObservableCollection<Location>();
        public string Duration { get; set; } = string.Empty;
        public string BreakSchedule { get; set; } = string.Empty;
        public ObservableCollection<string> RestPlaces { get; set; } = new ObservableCollection<string>();
        public ObservableCollection<string> PointsOfInterest { get; set; } = new ObservableCollection<string>();
        public bool IsActive { get; set; }
        public bool IsPredefined { get; set; } = true;

        public PredefinedTrip() { }

        public PredefinedTrip(string name, string description)
        {
            Name = name;
            Description = description;
        }

        public override string ToString() => Name;
    }
}




-----------------------------------------------------------------

Trip.cs
===



// Models/Trip.cs
using System.Collections.ObjectModel;

namespace TrackingApp.Models
{
    public class Trip
    {
        public string TripName { get; set; } = "Trip";
        public ObservableCollection<Location> Route { get; set; } = new ObservableCollection<Location>();
        public string Duration { get; set; } = "3 –≥–æ–¥–∏–Ω–∏";
        public string BreakSchedule { get; set; } = "–ü–µ—Ä–µ—Ä–≤–∞ –∑ 12:00 –¥–æ 13:00";
        public ObservableCollection<string> RestPlaces { get; set; } = new ObservableCollection<string>();
        public ObservableCollection<string> PointsOfInterest { get; set; } = new ObservableCollection<string>();
        public bool IsActive { get; set; } = true;
    }
}




-------------------------------------------------------------------



User.cs
===


using System;
using System.ComponentModel;
using System.Collections.ObjectModel;

namespace TrackingApp.Models
{
    public enum UserStatus
    {
        None,
        Help,
        Stop
    }

    public enum TripType
    {
        Walking,
        Cycling,
        Excursion
    }

    public class User : INotifyPropertyChanged
    {
        private string _name = string.Empty;
        private string _password = string.Empty;
        private Location _currentLocation = new Location();
        private bool _isLeader = false;
        private UserStatus _status = UserStatus.None;
        private string _email = string.Empty;
        private TripType _tripType = TripType.Walking; // Default to Walking

        public string Id { get; set; } = Guid.NewGuid().ToString();

        public string Name
        {
            get => _name;
            set { _name = value; OnPropertyChanged(nameof(Name)); }
        }

        public string Password
        {
            get => _password;
            set { _password = value; OnPropertyChanged(nameof(Password)); }
        }

        public Location CurrentLocation
        {
            get => _currentLocation;
            set { _currentLocation = value; OnPropertyChanged(nameof(CurrentLocation)); }
        }

        public bool IsLeader
        {
            get => _isLeader;
            set { _isLeader = value; OnPropertyChanged(nameof(IsLeader)); }
        }

        public UserStatus Status
        {
            get => _status;
            set { _status = value; OnPropertyChanged(nameof(Status)); }
        }

        public string Email
        {
            get => _email;
            set { _email = value; OnPropertyChanged(nameof(Email)); }
        }

        public TripType TripType
        {
            get => _tripType;
            set { _tripType = value; OnPropertyChanged(nameof(TripType)); }
        }

        public ObservableCollection<Location> LocationHistory { get; set; } = new ObservableCollection<Location>();

        public event PropertyChangedEventHandler? PropertyChanged;
        protected void OnPropertyChanged(string? prop) => PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(prop ?? string.Empty));
    }
}



----------------------------------------------------------------



–ü–ê–ü–ö–ê Service
========================



ApiResponse.cs
===




using System.Text.Json.Serialization;

namespace TrackingApp.Services
{
    public class ApiResponse<T>
    {
        [JsonPropertyName("success")]
        public bool Success { get; set; }

        [JsonPropertyName("message")]
        public string Message { get; set; } = string.Empty;

        [JsonPropertyName("data")]
        public T Data { get; set; }

        [JsonPropertyName("errorCode")]
        public string ErrorCode { get; set; } = string.Empty;

        public ApiResponse() { }

        public ApiResponse(bool success, string message, T data, string errorCode = "")
        {
            Success = success;
            Message = message;
            Data = data;
            ErrorCode = errorCode;
        }

        public static ApiResponse<T> SuccessResponse(T data, string message = "")
            => new ApiResponse<T>(true, message, data);

        public static ApiResponse<T> ErrorResponse(string message, string errorCode = "")
            => new ApiResponse<T>(false, message, default(T), errorCode);
    }

    public class ApiResponse
    {
        public bool Success { get; set; }
        public string Message { get; set; } = string.Empty;
        public string ErrorCode { get; set; } = string.Empty;

        public static ApiResponse SuccessResponse(string message = "")
            => new ApiResponse { Success = true, Message = message };

        public static ApiResponse ErrorResponse(string message, string errorCode = "")
            => new ApiResponse { Success = false, Message = message, ErrorCode = errorCode };
    }
}



---------------------------------------------------------------


ITrackingService.cs
====



// Services/ITrackingService.cs
using System.Collections.Generic;
using System.Threading.Tasks;
using TrackingApp.Models;

namespace TrackingApp.Services
{
    public interface ITrackingService
    {
        // –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ
        Task<List<User>> GetUsersAsync();
        Task<User> GetUserAsync(string userId);
        Task<bool> UpdateUserLocationAsync(string userId, Location location);
        Task<bool> UpdateUserStatusAsync(string userId, UserStatus status);

        // –ü–æ–¥–æ—Ä–æ–∂—ñ
        Task<Trip> GetCurrentTripAsync();
        Task<bool> UpdateTripAsync(Trip trip);
        Task<bool> SetRouteAsync(List<Location> route);

        // –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è
        Task<List<Notification>> GetNotificationsAsync();
        Task<bool> SendNotificationAsync(string message);
        Task<bool> SendFeedbackAsync(string feedback, int rating, User currentUser);

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
        Task<User> AuthenticateAsync(string username, string password);
        Task<bool> RegisterUserAsync(User user, string password);

        // –ù–æ–≤–∏–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∑'—î–¥–Ω–∞–Ω–Ω—è
        Task<bool> CheckServerConnectionAsync();
    }
}







--------------------------------------------------------


LocalDataService.cs
===



using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.IO;
using System.Text.Json;
using System.Linq;
using TrackingApp.Models;
using TrackingApp.Config;

namespace TrackingApp.Services
{
    public class LocalDataService
    {
        private List<User> _users;
        private Trip _currentTrip;
        private List<Notification> _notifications;

        public LocalDataService()
        {
            LoadOrCreateDefaultData();
        }

        private void LoadOrCreateDefaultData()
        {
            if (File.Exists(AppConfig.LocalDataFile))
            {
                LoadFromFile();
            }
            else
            {
                CreateDefaultData();
                SaveToFile();
            }
        }

        private void CreateDefaultData()
        {
            _users = new List<User>
            {
                new User
                {
                    Id = "1",
                    Name = "1111",
                    Email = "1111@example.com",
                    Password = "1111",
                    IsLeader = false,
                    TripType = TripType.Walking
                },
                new User
                {
                    Id = "2",
                    Name = "nazar_s",
                    Email = "nazar_s@example.com",
                    Password = "1111",
                    IsLeader = false,
                    TripType = TripType.Cycling
                },
                new User
                {
                    Id = "3",
                    Name = "admin1",
                    Email = "admin1@admin.com",
                    Password = "admin1",
                    IsLeader = true,
                    TripType = TripType.Excursion
                }
            };

            _currentTrip = new Trip
            {
                TripName = "–õ—å–≤—ñ–≤ - –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ–π–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç",
                Duration = "3 –≥–æ–¥–∏–Ω–∏",
                BreakSchedule = "–ü–µ—Ä–µ—Ä–≤–∞ –∑ 12:00 –¥–æ 13:00",
                RestPlaces = new ObservableCollection<string> { "–ü–∞—Ä–∫ –®–µ–≤—á–µ–Ω–∫–∞", "–ö–∞—Ñ–µ –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–µ" },
                PointsOfInterest = new ObservableCollection<string> { "–õ—å–≤—ñ–≤—Å—å–∫–∏–π –æ–ø–µ—Ä–Ω–∏–π —Ç–µ–∞—Ç—Ä", "–†–∏–Ω–æ–∫" },
                Route = new ObservableCollection<Location>
                {
                    new Location(49.842957, 24.031111),
                    new Location(49.844000, 24.032500),
                    new Location(49.845500, 24.034000)
                }
            };

            _notifications = new List<Notification>
            {
                new Notification { Message = "–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞", Time = DateTime.Now.AddMinutes(-5) },
                new Notification { Message = "–ú–∞—Ä—à—Ä—É—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ", Time = DateTime.Now.AddMinutes(-2) },
                new Notification { Message = "–í—Å—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –ø—ñ–¥–∫–ª—é—á–µ–Ω—ñ", Time = DateTime.Now.AddMinutes(-1) }
            };
        }

        // –ú–µ—Ç–æ–¥–∏ –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö
        public List<User> GetUsers()
        {
            // –ü—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —Å–∫–∏–¥–∞—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –Ω–∞ –ø–æ—á–∞—Ç–æ–∫ –º–∞—Ä—à—Ä—É—Ç—É
            var users = _users.Select(u => new User
            {
                Id = u.Id,
                Name = u.Name,
                Email = u.Email,
                Password = u.Password,
                IsLeader = u.IsLeader,
                TripType = u.TripType,
                CurrentLocation = GetRouteStartLocation(),
                LocationHistory = new ObservableCollection<Location>()
            }).ToList();

            return users;
        }

        public Trip GetCurrentTrip() => _currentTrip;
        public List<Notification> GetNotifications() => _notifications;

        // –ú–µ—Ç–æ–¥–∏ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
        public void SaveUser(User user)
        {
            var existing = _users.FirstOrDefault(u => u.Id == user.Id);
            if (existing != null)
            {
                _users.Remove(existing);
            }

            // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –æ—Å–Ω–æ–≤–Ω—ñ –¥–∞–Ω—ñ –±–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            var userToSave = new User
            {
                Id = user.Id,
                Name = user.Name,
                Email = user.Email,
                Password = user.Password,
                IsLeader = user.IsLeader,
                TripType = user.TripType
                // –ù–µ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ CurrentLocation —Ç–∞ LocationHistory
            };

            _users.Add(userToSave);
            SaveToFile();
        }

        public void UpdateTrip(Trip trip)
        {
            _currentTrip = trip;
            SaveToFile();
        }

        public void AddNotification(Notification notification)
        {
            _notifications.Insert(0, notification);
            SaveToFile();
        }

        public void AddLocationToRoute(Location location)
        {
            _currentTrip.Route.Add(location);
            SaveToFile();
        }

        public void ClearRoute()
        {
            _currentTrip.Route.Clear();
            SaveToFile();
        }

        // –ü–æ—à—É–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞ —ñ–º–µ–Ω–µ–º —Ç–∞ –ø–∞—Ä–æ–ª–µ–º
        public User FindUser(string username, string password)
        {
            var user = _users.FirstOrDefault(u => u.Name == username && u.Password == password);
            if (user != null)
            {
                // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –Ω–∞ –ø–æ—á–∞—Ç–∫—É –º–∞—Ä—à—Ä—É—Ç—É
                return new User
                {
                    Id = user.Id,
                    Name = user.Name,
                    Email = user.Email,
                    Password = user.Password,
                    IsLeader = user.IsLeader,
                    TripType = user.TripType,
                    CurrentLocation = GetRouteStartLocation(),
                    LocationHistory = new ObservableCollection<Location>()
                };
            }
            return null;
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ —ñ—Å–Ω—É—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á
        public bool UserExists(string username)
        {
            return _users.Any(u => u.Name == username);
        }

        private Location GetRouteStartLocation()
        {
            return _currentTrip.Route.Any()
                ? new Location(_currentTrip.Route.First().Latitude, _currentTrip.Route.First().Longitude)
                : new Location(49.842957, 24.031111); // –î–µ—Ñ–æ–ª—Ç–Ω—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –õ—å–≤–æ–≤–∞
        }

        private void LoadFromFile()
        {
            try
            {
                var json = File.ReadAllText(AppConfig.LocalDataFile);
                var data = JsonSerializer.Deserialize<LocalData>(json);

                _users = data?.Users ?? new List<User>();
                _currentTrip = data?.CurrentTrip ?? new Trip();
                _notifications = data?.Notifications ?? new List<Notification>();
            }
            catch (Exception ex)
            {
                // –Ø–∫—â–æ —Ñ–∞–π–ª –ø–æ—à–∫–æ–¥–∂–µ–Ω–∏–π, —Å—Ç–≤–æ—Ä—é—î–º–æ –¥–∞–Ω—ñ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
                System.Diagnostics.Debug.WriteLine($"–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö: {ex.Message}");
                CreateDefaultData();
            }
        }

        private void SaveToFile()
        {
            try
            {
                var data = new LocalData
                {
                    Users = _users,
                    CurrentTrip = _currentTrip,
                    Notifications = _notifications
                };

                var json = JsonSerializer.Serialize(data, new JsonSerializerOptions { WriteIndented = true });
                File.WriteAllText(AppConfig.LocalDataFile, json);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö: {ex.Message}");
            }
        }

        // –ú–æ–¥–µ–ª—å –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö
        private class LocalData
        {
            public List<User> Users { get; set; } = new List<User>();
            public Trip CurrentTrip { get; set; } = new Trip();
            public List<Notification> Notifications { get; set; } = new List<Notification>();
        }
    }
}






-----------------------------------------------------------------


TrackingService.cs
====



using System;
using System.Collections.Generic;
using System.IO;
using System.Net.Sockets;
using System.Text;
using System.Text.Json;
using System.Threading.Tasks;
using TrackingApp.Config;
using TrackingApp.Infrastructure;
using TrackingApp.Models;

namespace TrackingApp.Services
{
    public class TrackingService : ITrackingService
    {
        private readonly IHttpClient _httpClient;

        public TrackingService()
        {
            _httpClient = HttpClientFactory.CreateClient();
            AppConfig.LogConfiguration();
        }

        // –î–û–î–ê–ù–û: –ú–µ—Ç–æ–¥ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–ª–∞–Ω—É –ø–æ–¥–æ—Ä–æ–∂—ñ
        public async Task<bool> UpdateTripPlanAsync(string tripId, string duration, string breakSchedule,
                                                   List<string> restPlaces, List<string> pointsOfInterest,
                                                   string updatedBy)
        {
            try
            {
                System.Diagnostics.Debug.WriteLine($"üìù –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–ª–∞–Ω—É –ø–æ–¥–æ—Ä–æ–∂—ñ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç—É: {tripId}");

                var result = await _httpClient.PostAsync<object>("/api/trip/plan/update", new
                {
                    TripId = tripId,
                    Duration = duration,
                    BreakSchedule = breakSchedule,
                    RestPlaces = restPlaces,
                    PointsOfInterest = pointsOfInterest,
                    UpdatedBy = updatedBy
                });

                System.Diagnostics.Debug.WriteLine($"‚úÖ –ü–ª–∞–Ω –ø–æ–¥–æ—Ä–æ–∂—ñ –æ–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç—É: {tripId}");
                return true;
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–ª–∞–Ω—É –ø–æ–¥–æ—Ä–æ–∂—ñ: {ex.Message}");
                return false;
            }
        }

        public async Task<List<PredefinedTrip>> GetPredefinedTripsAsync()
        {
            try
            {
                System.Diagnostics.Debug.WriteLine("üó∫Ô∏è –ó–∞–ø–∏—Ç –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤ —á–µ—Ä–µ–∑ TCP...");
                var trips = await _httpClient.GetAsync<List<PredefinedTrip>>("/api/trips/predefined");

                System.Diagnostics.Debug.WriteLine($"‚úÖ –û—Ç—Ä–∏–º–∞–Ω–æ {trips?.Count ?? 0} –º–∞—Ä—à—Ä—É—Ç—ñ–≤");
                return trips ?? new List<PredefinedTrip>();
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—ñ–≤: {ex.Message}");
                return new List<PredefinedTrip>();
            }
        }

        public async Task<bool> SetActiveTripAsync(string tripId)
        {
            try
            {
                System.Diagnostics.Debug.WriteLine($"üéØ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É: {tripId}");

                var result = await _httpClient.PostAsync<object>("/api/trips/set_active", new
                {
                    TripId = tripId
                });

                System.Diagnostics.Debug.WriteLine($"‚úÖ –ê–∫—Ç–∏–≤–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ: {tripId}");
                return true;
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É: {ex.Message}");
                return false;
            }
        }

        public async Task<bool> SavePredefinedTripAsync(PredefinedTrip trip)
        {
            try
            {
                System.Diagnostics.Debug.WriteLine($"üíæ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É: {trip.Name}");

                var result = await _httpClient.PostAsync<object>("/api/trips/save_predefined", trip);

                System.Diagnostics.Debug.WriteLine($"‚úÖ –ú–∞—Ä—à—Ä—É—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ: {trip.Name}");
                return true;
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É: {ex.Message}");
                return false;
            }
        }

        public async Task<Trip> GetActiveTripAsync()
        {
            try
            {
                System.Diagnostics.Debug.WriteLine("üó∫Ô∏è –ó–∞–ø–∏—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É —á–µ—Ä–µ–∑ TCP...");
                var trip = await _httpClient.GetAsync<Trip>("/api/trip/active");

                if (trip != null && !string.IsNullOrEmpty(trip.TripName) && trip.Route != null && trip.Route.Count > 0)
                {
                    System.Diagnostics.Debug.WriteLine($"‚úÖ –û—Ç—Ä–∏–º–∞–Ω–æ –∞–∫—Ç–∏–≤–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç: {trip.TripName}");
                    System.Diagnostics.Debug.WriteLine($"üìç –ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ—á–æ–∫: {trip.Route.Count}");
                    return trip;
                }
                else
                {
                    System.Diagnostics.Debug.WriteLine("‚ÑπÔ∏è –ê–∫—Ç–∏–≤–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞–±–æ –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π");
                    return new Trip();
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É: {ex.Message}");
                return new Trip();
            }
        }

        public async Task<Trip> GetCurrentTripAsync()
        {
            return await GetActiveTripAsync();
        }

        public async Task<bool> CheckServerConnectionAsync()
        {
            try
            {
                if (!AppConfig.UseServerMode)
                {
                    System.Diagnostics.Debug.WriteLine("üîß –õ–æ–∫–∞–ª—å–Ω–∏–π —Ä–µ–∂–∏–º - TCP —Å–µ—Ä–≤–µ—Ä –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è");
                    return true;
                }

                System.Diagnostics.Debug.WriteLine($"üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ TCP –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ: {AppConfig.ServerHost}:{AppConfig.ServerPort}");

                using var client = new TcpClient();

                var connectTask = client.ConnectAsync(AppConfig.ServerHost, AppConfig.ServerPort);
                var timeoutTask = Task.Delay(TimeSpan.FromSeconds(5));

                var completedTask = await Task.WhenAny(connectTask, timeoutTask);

                if (completedTask == timeoutTask)
                {
                    System.Diagnostics.Debug.WriteLine("‚ùå –¢–ê–ô–ú–ê–£–¢ –ü–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø: –°–µ—Ä–≤–µ—Ä –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –ø—Ä–æ—Ç—è–≥–æ–º 5 —Å–µ–∫—É–Ω–¥");
                    return false;
                }

                if (client.Connected)
                {
                    System.Diagnostics.Debug.WriteLine("‚úÖ TCP —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–Ω–∏–π! –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∏ ping...");

                    try
                    {
                        var jsonOptions = new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase };
                        var request = new { Command = "ping", Data = new { } };
                        var jsonRequest = JsonSerializer.Serialize(request, jsonOptions);

                        using var stream = client.GetStream();
                        using var writer = new StreamWriter(stream, Encoding.UTF8) { AutoFlush = true };
                        using var reader = new StreamReader(stream, Encoding.UTF8);

                        await writer.WriteLineAsync(jsonRequest);
                        var responseJson = await reader.ReadLineAsync();

                        System.Diagnostics.Debug.WriteLine($"‚úÖ TCP ping —É—Å–ø—ñ—à–Ω–∏–π: {responseJson}");
                        return true;
                    }
                    catch (Exception ex)
                    {
                        System.Diagnostics.Debug.WriteLine($"‚ùå TCP ping –Ω–µ –≤–¥–∞–≤—à–∏–π—Å—è: {ex.Message}");
                        return false;
                    }
                }

                return false;
            }
            catch (SocketException ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ TCP —Å–æ–∫–µ—Ç–∞: {ex.Message}");
                return false;
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ù–µ—Å–ø–æ–¥—ñ–≤–∞–Ω–∞ –ø–æ–º–∏–ª–∫–∞ TCP: {ex.Message}");
                return false;
            }
        }

        public async Task<List<User>> GetUsersAsync()
        {
            try
            {
                System.Diagnostics.Debug.WriteLine("üì• –ó–∞–ø–∏—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —á–µ—Ä–µ–∑ TCP...");
                return await _httpClient.GetAsync<List<User>>("/api/users");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤: {ex.Message}");
                return new List<User>();
            }
        }

        public async Task<User> GetUserAsync(string userId)
        {
            try
            {
                var users = await GetUsersAsync();
                return users?.Find(u => u.Id == userId);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {userId}: {ex.Message}");
                return null;
            }
        }

        public async Task<bool> UpdateUserLocationAsync(string userId, Location location)
        {
            try
            {
                System.Diagnostics.Debug.WriteLine($"üìç –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ—ó –¥–ª—è {userId} —á–µ—Ä–µ–∑ TCP");
                var result = await _httpClient.PutAsync<object>($"/api/users/{userId}/location", new
                {
                    UserId = userId,
                    Location = location
                });
                return true;
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ—ó: {ex.Message}");
                return false;
            }
        }

        public async Task<bool> UpdateUserStatusAsync(string userId, UserStatus status)
        {
            try
            {
                var message = status == UserStatus.Help ? "–ü–æ—Ç—Ä—ñ–±–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞" : "–ü–æ—Ç—Ä—ñ–±–Ω–∞ –∑—É–ø–∏–Ω–∫–∞";
                System.Diagnostics.Debug.WriteLine($"üîÑ –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –¥–ª—è {userId}: {message}");

                await SendNotificationAsync($"{userId}: {message}");
                return true;
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É: {ex.Message}");
                return false;
            }
        }

        public async Task<bool> UpdateTripAsync(Trip trip)
        {
            System.Diagnostics.Debug.WriteLine("‚ö†Ô∏è –û–Ω–æ–≤–ª–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ predefined trips");
            return false;
        }

        public async Task<bool> SetRouteAsync(List<Location> route)
        {
            try
            {
                var trip = await GetCurrentTripAsync();
                if (trip != null)
                {
                    trip.Route = new System.Collections.ObjectModel.ObservableCollection<Location>(route);
                    return await UpdateTripAsync(trip);
                }
                return false;
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É: {ex.Message}");
                return false;
            }
        }

        public async Task<List<Notification>> GetNotificationsAsync()
        {
            try
            {
                System.Diagnostics.Debug.WriteLine("üì¢ –ó–∞–ø–∏—Ç —Å–ø–æ–≤—ñ—â–µ–Ω—å —á–µ—Ä–µ–∑ TCP...");
                return await _httpClient.GetAsync<List<Notification>>("/api/notifications");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω—å: {ex.Message}");
                return new List<Notification>();
            }
        }

        public async Task<bool> SendNotificationAsync(string message)
        {
            try
            {
                System.Diagnostics.Debug.WriteLine($"üì¢ –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è —á–µ—Ä–µ–∑ TCP: {message}");
                var result = await _httpClient.PostAsync<object>("/api/notifications", new
                {
                    Message = message,
                    UserId = "",
                    UserName = "System"
                });
                return true;
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è: {ex.Message}");
                return false;
            }
        }

        public async Task<bool> SendFeedbackAsync(string feedback, int rating, User currentUser)
        {
            try
            {
                System.Diagnostics.Debug.WriteLine($"üí¨ –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –≤—ñ–¥–≥—É–∫—É —á–µ—Ä–µ–∑ TCP: {feedback} (–†–µ–π—Ç–∏–Ω–≥: {rating}/5)");

                if (currentUser == null)
                {
                    System.Diagnostics.Debug.WriteLine("‚ùå –ü–æ–º–∏–ª–∫–∞: –ø–æ—Ç–æ—á–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–∏–π");
                    return false;
                }

                var currentTrip = await GetCurrentTripAsync();

                System.Diagnostics.Debug.WriteLine($"   –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: {currentUser.Name}");
                System.Diagnostics.Debug.WriteLine($"   –ü–æ—Ç–æ—á–Ω–∞ –ø–æ–¥–æ—Ä–æ–∂: {currentTrip?.TripName ?? "–ù–µ –≤–∏–∑–Ω–∞—á–µ–Ω–æ"}");

                var result = await _httpClient.PostAsync<object>("/api/feedback", new
                {
                    UserId = currentUser.Id,
                    UserName = currentUser.Name,
                    Message = feedback,
                    Rating = rating,
                    TripName = currentTrip?.TripName ?? "–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–¥–æ—Ä–æ–∂"
                });

                System.Diagnostics.Debug.WriteLine($"‚úÖ –í—ñ–¥–≥—É–∫ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –≤—ñ–¥ {currentUser.Name}");
                return true;
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –≤—ñ–¥–≥—É–∫—É: {ex.Message}");
                System.Diagnostics.Debug.WriteLine($"   StackTrace: {ex.StackTrace}");
                return false;
            }
        }

        public async Task<User> AuthenticateAsync(string username, string password)
        {
            try
            {
                System.Diagnostics.Debug.WriteLine($"üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —á–µ—Ä–µ–∑ TCP: {username}");
                var users = await GetUsersAsync();
                return users?.Find(u => u.Name == username && u.Password == password);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó: {ex.Message}");
                return null;
            }
        }

        public async Task<bool> RegisterUserAsync(User user, string password)
        {
            try
            {
                System.Diagnostics.Debug.WriteLine($"üìù –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —á–µ—Ä–µ–∑ TCP: {user.Name}");

                var result = await _httpClient.PostAsync<object>("/api/auth/register", new
                {
                    Name = user.Name,
                    Email = user.Email,
                    Password = password,
                    IsLeader = user.IsLeader,
                    TripType = user.TripType
                });

                System.Diagnostics.Debug.WriteLine($"‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {user.Name} —É—Å–ø—ñ—à–Ω–æ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö");
                return true;
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó: {ex.Message}");
                return false;
            }
        }
    }
}







-----------------------------------------------------------------------


–ü–ê–ü–ö–ê Themes
===============================


Styles.xaml
===


<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:converters="clr-namespace:TrackingApp.Converters">
    <converters:BoolToBrushConverter x:Key="BoolToBrushConverter"/>
    <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

    <SolidColorBrush x:Key="PrimaryColor" Color="#FF2D8CFF"/>
    <SolidColorBrush x:Key="SecondaryColor" Color="#FFECECEC"/>

    <Style x:Key="HeaderText" TargetType="TextBlock">
        <Setter Property="FontSize" Value="16"/>
        <Setter Property="FontWeight" Value="Bold"/>
        <Setter Property="Margin" Value="0,8,0,8"/>
    </Style>

    <Style x:Key="PrimaryButton" TargetType="Button">
        <Setter Property="Background" Value="{StaticResource PrimaryColor}"/>
        <Setter Property="Foreground" Value="White"/>
        <Setter Property="Padding" Value="6,4"/>
        <Setter Property="BorderThickness" Value="0"/>
        <Setter Property="Margin" Value="4"/>
        <Setter Property="Cursor" Value="Hand"/>
    </Style>

    <Style x:Key="SecondaryButton" TargetType="Button">
        <Setter Property="Background" Value="{StaticResource SecondaryColor}"/>
        <Setter Property="Foreground" Value="Black"/>
        <Setter Property="Padding" Value="6,4"/>
        <Setter Property="BorderBrush" Value="Gray"/>
        <Setter Property="BorderThickness" Value="1"/>
        <Setter Property="Margin" Value="4"/>
    </Style>
</ResourceDictionary>


-------------------------------------------------------



–ü–ê–ü–ö–ê ViewModels
================================


MainViewModel.cs
====



using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Linq;
using System.Timers;
using System.Windows;
using System.Threading.Tasks;
using TrackingApp.Models;
using TrackingApp.Services;

namespace TrackingApp.ViewModels
{
    public class MainViewModel : INotifyPropertyChanged
    {
        private readonly System.Timers.Timer _gpsTimer;
        private readonly System.Timers.Timer _statusReminderTimer;
        private readonly System.Timers.Timer _dataRefreshTimer;
        private readonly Random _rnd = new Random();
        private readonly LocalDataService _localDataService;
        private readonly TrackingService _trackingService;
        private const double WalkingSpeedMps = 1.4;
        private const double CyclingSpeedMps = 5.5;
        private const double ExcursionSpeedMps = 0.8;
        private const double MaxDeviationKm = 0.1;
        private const double GpsNoiseMeters = 5.0;
        private const int StatusReminderIntervalMs = 180000;
        private const int DataRefreshIntervalMs = 10000;
        private const int MaxReminderCount = 3;

        private Dictionary<string, int> _userReminderCounts = new Dictionary<string, int>();
        private bool _isDataLoading = false;

        public ObservableCollection<User> Users { get; set; } = new ObservableCollection<User>();
        private ObservableCollection<Notification> _allNotifications = new ObservableCollection<Notification>();
        public ObservableCollection<Notification> AllNotifications
        {
            get => _allNotifications;
            set
            {
                _allNotifications = value;
                OnPropertyChanged(nameof(AllNotifications));
                OnPropertyChanged(nameof(UserNotifications));
            }
        }

        private Trip _currentTrip = new Trip();
        public Trip CurrentTrip
        {
            get => _currentTrip;
            set
            {
                _currentTrip = value;
                OnPropertyChanged(nameof(CurrentTrip));
                OnPropertyChanged(nameof(CurrentTrip.TripName));
            }
        }

        private User _selectedUser;
        public User SelectedUser
        {
            get => _selectedUser;
            set { _selectedUser = value; OnPropertyChanged(nameof(SelectedUser)); }
        }

        private User _currentUser;
        public User CurrentUser
        {
            get => _currentUser;
            set
            {
                _currentUser = value;

                if (_currentUser != null && !_currentUser.IsLeader)
                {
                    ClearUserNotifications();
                }

                OnPropertyChanged(nameof(CurrentUser));
                OnPropertyChanged(nameof(IsLeaderView));
                OnPropertyChanged(nameof(IsParticipantView));
                OnPropertyChanged(nameof(UserNotifications));
            }
        }

        private bool _showNotifications = true;
        public bool ShowNotifications
        {
            get => _showNotifications;
            set
            {
                _showNotifications = value;
                OnPropertyChanged(nameof(ShowNotifications));
                OnPropertyChanged(nameof(UserNotifications));
            }
        }

        public bool IsLeaderView => CurrentUser?.IsLeader ?? false;
        public bool IsParticipantView => CurrentUser != null && !CurrentUser.IsLeader;

        private ObservableCollection<PredefinedTrip> _predefinedTrips = new ObservableCollection<PredefinedTrip>();
        public ObservableCollection<PredefinedTrip> PredefinedTrips
        {
            get => _predefinedTrips;
            set { _predefinedTrips = value; OnPropertyChanged(nameof(PredefinedTrips)); }
        }

        private PredefinedTrip _selectedPredefinedTrip;
        public PredefinedTrip SelectedPredefinedTrip
        {
            get => _selectedPredefinedTrip;
            set
            {
                _selectedPredefinedTrip = value;
                OnPropertyChanged(nameof(SelectedPredefinedTrip));
            }
        }

        public ObservableCollection<Notification> UserNotifications
        {
            get
            {
                if (CurrentUser == null) return new ObservableCollection<Notification>();
                if (!_showNotifications) return new ObservableCollection<Notification>();

                if (CurrentUser.IsLeader)
                {
                    return AllNotifications;
                }
                else
                {
                    return new ObservableCollection<Notification>(
                        AllNotifications.Where(n =>
                            n.Message.Contains(CurrentUser.Name) ||
                            n.Message.StartsWith("–í–∏ ") ||
                            n.Message.StartsWith("–í–∞—à ") ||
                            n.Message.Contains($" {CurrentUser.Name} ") ||
                            n.Message.EndsWith($" {CurrentUser.Name}") ||
                            (n.UserId == CurrentUser.Id && !string.IsNullOrEmpty(n.UserId))
                        ).ToList());
                }
            }
        }

        public event Action MapUpdateRequested;

        public MainViewModel()
        {
            _localDataService = new LocalDataService();
            _trackingService = new TrackingService();

            LoadData();

            _ = LoadPredefinedTripsAsync();

            _gpsTimer = new System.Timers.Timer(1000);
            _gpsTimer.Elapsed += GpsTimer_Elapsed;
            _gpsTimer.Start();

            _statusReminderTimer = new System.Timers.Timer(StatusReminderIntervalMs);
            _statusReminderTimer.Elapsed += StatusReminderTimer_Elapsed;
            _statusReminderTimer.Start();

            _dataRefreshTimer = new System.Timers.Timer(DataRefreshIntervalMs);
            _dataRefreshTimer.Elapsed += DataRefreshTimer_Elapsed;
            _dataRefreshTimer.Start();
        }

        public TrackingService TrackingService => _trackingService;

        public async Task<bool> SaveCurrentTripToServer()
        {
            try
            {
                if (CurrentTrip == null) return false;

                await LoadTripDataImmediately();

                System.Diagnostics.Debug.WriteLine("‚úÖ –î–∞–Ω—ñ –º–∞—Ä—à—Ä—É—Ç—É –æ–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ");
                return true;
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É: {ex.Message}");
                AddNotification($"‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É: {ex.Message}");
                return false;
            }
        }

        public async Task<bool> SendFeedbackAsync(string feedback, int rating)
        {
            try
            {
                if (CurrentUser == null)
                {
                    System.Diagnostics.Debug.WriteLine("‚ùå –ü–æ—Ç–æ—á–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–∏–π");
                    return false;
                }

                System.Diagnostics.Debug.WriteLine($"üí¨ –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –≤—ñ–¥–≥—É–∫—É —á–µ—Ä–µ–∑ TrackingService...");
                System.Diagnostics.Debug.WriteLine($"   –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: {CurrentUser.Name}");
                System.Diagnostics.Debug.WriteLine($"   –í—ñ–¥–≥—É–∫: {feedback}");
                System.Diagnostics.Debug.WriteLine($"   –†–µ–π—Ç–∏–Ω–≥: {rating}");

                // –í–∏–∫–ª–∏–∫–∞—î–º–æ —Å–µ—Ä–≤—ñ—Å –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
                var success = await _trackingService.SendFeedbackAsync(feedback, rating, CurrentUser);

                if (success)
                {
                    System.Diagnostics.Debug.WriteLine("‚úÖ –í—ñ–¥–≥—É–∫ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä");

                    // –¢–∏—Ö–∏–π —É—Å–ø—ñ—Ö - –±–µ–∑ —Å–ø–æ–≤—ñ—â–µ–Ω—å –¥–ª—è –∑–≤–∏—á–∞–π–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
                    // –¢—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –±–∞—á–∏—Ç—å —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –Ω–æ–≤–∏–π –≤—ñ–¥–≥—É–∫
                    if (IsLeaderView)
                    {
                        AddNotification($"‚≠ê –û—Ç—Ä–∏–º–∞–Ω–æ –Ω–æ–≤–∏–π –≤—ñ–¥–≥—É–∫ –≤—ñ–¥ {CurrentUser.Name} ({rating}/5)");
                    }

                    return true; // ‚úÖ –£—Å–ø—ñ—à–Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
                }
                else
                {
                    System.Diagnostics.Debug.WriteLine("‚ùå TrackingService –ø–æ–≤–µ—Ä–Ω—É–≤ false");
                    return false;
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –≤ SendFeedbackAsync: {ex.Message}");
                System.Diagnostics.Debug.WriteLine($"   StackTrace: {ex.StackTrace}");
                return false;
            }
        }

        public async Task SetActiveTripAsync()
        {
            if (SelectedPredefinedTrip == null)
            {
                System.Diagnostics.Debug.WriteLine("‚ùå –ú–∞—Ä—à—Ä—É—Ç –Ω–µ –≤–∏–±—Ä–∞–Ω–æ");
                AddNotification("‚ùå –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç");
                return;
            }

            try
            {
                var tripId = SelectedPredefinedTrip.Id;
                System.Diagnostics.Debug.WriteLine($"üéØ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É: {SelectedPredefinedTrip.Name}");

                var success = await _trackingService.SetActiveTripAsync(tripId);
                if (success)
                {
                    await LoadTripDataImmediately();
                    AddNotification($"‚úÖ –ê–∫—Ç–∏–≤–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç –æ–Ω–æ–≤–ª–µ–Ω–æ: {SelectedPredefinedTrip.Name}");

                    Application.Current?.Dispatcher?.Invoke(() =>
                    {
                        foreach (var trip in PredefinedTrips)
                        {
                            trip.IsActive = (trip.Id == tripId);
                        }
                        OnPropertyChanged(nameof(PredefinedTrips));
                    });
                }
                else
                {
                    AddNotification("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç");
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É: {ex.Message}");
                AddNotification($"‚ùå –ü–æ–º–∏–ª–∫–∞: {ex.Message}");
            }
        }

        public async Task<bool> UpdateTripPlanAsync(string duration, string breakSchedule,
                                                   ObservableCollection<string> restPlaces,
                                                   ObservableCollection<string> pointsOfInterest)
        {
            try
            {
                if (SelectedPredefinedTrip == null)
                {
                    System.Diagnostics.Debug.WriteLine("‚ùå –ú–∞—Ä—à—Ä—É—Ç –Ω–µ –≤–∏–±—Ä–∞–Ω–æ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–ª–∞–Ω—É");
                    AddNotification("‚ùå –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–ª–∞–Ω—É");
                    return false;
                }

                var tripId = SelectedPredefinedTrip.Id;
                var updatedBy = CurrentUser?.Name ?? "–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä";

                System.Diagnostics.Debug.WriteLine($"üìù –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–ª–∞–Ω—É –ø–æ–¥–æ—Ä–æ–∂—ñ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç—É: {SelectedPredefinedTrip.Name}");

                var success = await _trackingService.UpdateTripPlanAsync(
                    tripId,
                    duration,
                    breakSchedule,
                    restPlaces?.ToList() ?? new List<string>(),
                    pointsOfInterest?.ToList() ?? new List<string>(),
                    updatedBy
                );

                if (success)
                {
                    // –û–Ω–æ–≤–ª—é—î–º–æ –ª–æ–∫–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ
                    CurrentTrip.Duration = duration;
                    CurrentTrip.BreakSchedule = breakSchedule;
                    CurrentTrip.RestPlaces = restPlaces;
                    CurrentTrip.PointsOfInterest = pointsOfInterest;

                    AddNotification($"‚úÖ –ü–ª–∞–Ω –ø–æ–¥–æ—Ä–æ–∂—ñ –æ–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç—É: {SelectedPredefinedTrip.Name}");
                    OnPropertyChanged(nameof(CurrentTrip));

                    return true;
                }
                else
                {
                    AddNotification("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –ø–ª–∞–Ω –ø–æ–¥–æ—Ä–æ–∂—ñ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ");
                    return false;
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–ª–∞–Ω—É –ø–æ–¥–æ—Ä–æ–∂—ñ: {ex.Message}");
                AddNotification($"‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–ª–∞–Ω—É –ø–æ–¥–æ—Ä–æ–∂—ñ: {ex.Message}");
                return false;
            }
        }

        private async void DataRefreshTimer_Elapsed(object sender, ElapsedEventArgs e)
        {
            if (_isDataLoading) return;

            try
            {
                _isDataLoading = true;
                await LoadDataFromService();
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö: {ex.Message}");
            }
            finally
            {
                _isDataLoading = false;
            }
        }

        public async Task LoadPredefinedTripsAsync()
        {
            try
            {
                System.Diagnostics.Debug.WriteLine("üîÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤...");

                var trips = await _trackingService.GetPredefinedTripsAsync();

                Application.Current?.Dispatcher?.Invoke(() =>
                {
                    PredefinedTrips.Clear();
                    foreach (var trip in trips)
                    {
                        PredefinedTrips.Add(trip);
                    }

                    var activeTrip = trips.FirstOrDefault(t => t.IsActive);
                    if (activeTrip != null)
                    {
                        SelectedPredefinedTrip = activeTrip;
                        System.Diagnostics.Debug.WriteLine($"üìç –ü–æ—Ç–æ—á–Ω–∏–π –∞–∫—Ç–∏–≤–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç: {activeTrip.Name}");
                    }
                    else if (trips.Any())
                    {
                        SelectedPredefinedTrip = trips.First();
                    }

                    System.Diagnostics.Debug.WriteLine($"‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ {trips.Count} –º–∞—Ä—à—Ä—É—Ç—ñ–≤");
                });
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—ñ–≤: {ex.Message}");
            }
        }

        private async Task LoadTripDataImmediately()
        {
            try
            {
                var trip = await _trackingService.GetActiveTripAsync();

                Application.Current?.Dispatcher?.Invoke(() =>
                {
                    if (trip != null && !string.IsNullOrEmpty(trip.TripName) && trip.IsActive)
                    {
                        UpdateTripData(trip);
                        System.Diagnostics.Debug.WriteLine($"‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ –¥–∞–Ω—ñ –º–∞—Ä—à—Ä—É—Ç—É: {trip.TripName}");
                    }
                });
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É: {ex.Message}");
            }
        }

        private async Task LoadDataFromService()
        {
            if (_isDataLoading) return;

            try
            {
                _isDataLoading = true;
                System.Diagnostics.Debug.WriteLine("üîÑ LoadDataFromService - –ø–æ—á–∞—Ç–æ–∫");

                var users = await _trackingService.GetUsersAsync();
                var trip = await _trackingService.GetActiveTripAsync();
                var notifications = await _trackingService.GetNotificationsAsync();

                System.Diagnostics.Debug.WriteLine($"üìç –û—Ç—Ä–∏–º–∞–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤: {users.Count}");
                System.Diagnostics.Debug.WriteLine($"üìç –û—Ç—Ä–∏–º–∞–Ω–æ –º–∞—Ä—à—Ä—É—Ç: {trip?.TripName ?? "null"}");
                System.Diagnostics.Debug.WriteLine($"üìç –û—Ç—Ä–∏–º–∞–Ω–æ —Å–ø–æ–≤—ñ—â–µ–Ω—å: {notifications.Count}");

                Application.Current?.Dispatcher?.Invoke(() =>
                {
                    Users.Clear();
                    foreach (var user in users)
                    {
                        Users.Add(user);
                    }

                    if (trip != null && !string.IsNullOrEmpty(trip.TripName) && trip.IsActive)
                    {
                        UpdateTripData(trip);
                        System.Diagnostics.Debug.WriteLine($"‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ –¥–∞–Ω—ñ –º–∞—Ä—à—Ä—É—Ç—É: {trip.TripName}");
                    }
                    else
                    {
                        CurrentTrip.TripName = "–û–±–µ—Ä—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç";
                        CurrentTrip.Duration = "–ù–µ –≤–∫–∞–∑–∞–Ω–æ";
                        CurrentTrip.BreakSchedule = "–ù–µ –≤–∫–∞–∑–∞–Ω–æ";
                        CurrentTrip.RestPlaces = new ObservableCollection<string>();
                        CurrentTrip.PointsOfInterest = new ObservableCollection<string>();
                        CurrentTrip.Route = new ObservableCollection<Location>();
                        CurrentTrip.IsActive = false;

                        System.Diagnostics.Debug.WriteLine("‚ÑπÔ∏è –ê–∫—Ç–∏–≤–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ");
                    }

                    AllNotifications.Clear();
                    foreach (var notification in notifications)
                    {
                        AllNotifications.Add(notification);
                    }

                    OnPropertyChanged(nameof(CurrentTrip));
                    MapUpdateRequested?.Invoke();

                    System.Diagnostics.Debug.WriteLine("üîÑ LoadDataFromService - –∫—ñ–Ω–µ—Ü—å");
                });
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–û–ú–ò–õ–ö–ê –≤ LoadDataFromService: {ex.Message}");
                Application.Current?.Dispatcher?.Invoke(() =>
                {
                    AddNotification($"‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö: {ex.Message}");
                });
            }
            finally
            {
                _isDataLoading = false;
            }
        }

        private void UpdateTripData(Trip newTrip)
        {
            System.Diagnostics.Debug.WriteLine($"üîÑ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø–æ–¥–æ—Ä–æ–∂—ñ: {newTrip.TripName}");

            CurrentTrip.TripName = newTrip.TripName;
            CurrentTrip.Duration = newTrip.Duration;
            CurrentTrip.BreakSchedule = newTrip.BreakSchedule;
            CurrentTrip.IsActive = newTrip.IsActive;

            CurrentTrip.RestPlaces.Clear();
            foreach (var place in newTrip.RestPlaces)
                CurrentTrip.RestPlaces.Add(place);

            CurrentTrip.PointsOfInterest.Clear();
            foreach (var point in newTrip.PointsOfInterest)
                CurrentTrip.PointsOfInterest.Add(point);

            CurrentTrip.Route.Clear();
            foreach (var location in newTrip.Route)
                CurrentTrip.Route.Add(location);

            OnPropertyChanged(nameof(CurrentTrip));
            OnPropertyChanged(nameof(CurrentTrip.TripName));
            OnPropertyChanged(nameof(CurrentTrip.Route));
            OnPropertyChanged(nameof(CurrentTrip.RestPlaces));
            OnPropertyChanged(nameof(CurrentTrip.PointsOfInterest));
        }

        private void ClearUserNotifications()
        {
            try
            {
                if (CurrentUser == null) return;

                var notificationsToRemove = AllNotifications
                    .Where(n => n.Message.StartsWith(CurrentUser.Name) ||
                               n.Message.StartsWith("–í–∏") ||
                               n.Message.Contains(CurrentUser.Name))
                    .ToList();

                foreach (var notification in notificationsToRemove)
                {
                    AllNotifications.Remove(notification);
                }

                try
                {
                    var method = _localDataService.GetType().GetMethod("ClearUserNotifications");
                    if (method != null)
                    {
                        method.Invoke(_localDataService, new object[] { CurrentUser.Name });
                    }
                }
                catch
                {
                }

                OnPropertyChanged(nameof(AllNotifications));
                OnPropertyChanged(nameof(UserNotifications));
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"–ü–æ–º–∏–ª–∫–∞ –æ—á–∏—â–µ–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: {ex.Message}");
            }
        }

        private void StatusReminderTimer_Elapsed(object sender, ElapsedEventArgs e)
        {
            try
            {
                Application.Current?.Dispatcher?.Invoke(() =>
                {
                    foreach (var user in Users.Where(u => u.Status != UserStatus.None))
                    {
                        if (!_userReminderCounts.ContainsKey(user.Id))
                        {
                            _userReminderCounts[user.Id] = 0;
                        }

                        if (_userReminderCounts[user.Id] < MaxReminderCount)
                        {
                            _userReminderCounts[user.Id]++;

                            string statusText = user.Status == UserStatus.Help ? "–î–û–ü–û–ú–û–ì–£" : "–ó–£–ü–ò–ù–ö–£";
                            string reminderText = user.Status == UserStatus.Help ? "–ø–æ—Ç—Ä—ñ–±–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞" : "–ø–æ—Ç—Ä—ñ–±–Ω–∞ –∑—É–ø–∏–Ω–∫–∞";

                            string message = $"{user.Name} —â–µ {reminderText} (–Ω–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è {_userReminderCounts[user.Id]}/{MaxReminderCount})";

                            AddNotification(message);

                            if (_userReminderCounts[user.Id] >= MaxReminderCount)
                            {
                                user.Status = UserStatus.None;
                                AddNotification($"–°—Ç–∞—Ç—É—Å {statusText} –¥–ª—è {user.Name} –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–∫–∏–Ω—É—Ç–æ –ø—ñ—Å–ª—è {MaxReminderCount} –Ω–∞–≥–∞–¥—É–≤–∞–Ω—å");

                                try
                                {
                                    _localDataService.SaveUser(user);
                                }
                                catch (Exception ex)
                                {
                                    System.Diagnostics.Debug.WriteLine($"–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: {ex.Message}");
                                }
                            }
                        }
                    }
                });
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"–ü–æ–º–∏–ª–∫–∞ —Ç–∞–π–º–µ—Ä–∞ –Ω–∞–≥–∞–¥—É–≤–∞–Ω—å: {ex.Message}");
            }
        }

        public void AddNotification(string message)
        {
            Application.Current?.Dispatcher?.Invoke(() =>
            {
                var notification = new Notification
                {
                    Message = message,
                    Time = DateTime.Now,
                    UserId = CurrentUser?.Id ?? "",
                    UserName = CurrentUser?.Name ?? "–°–∏—Å—Ç–µ–º–∞"
                };
                AllNotifications.Insert(0, notification);

                try
                {
                    _localDataService.AddNotification(notification);
                }
                catch (Exception ex)
                {
                    System.Diagnostics.Debug.WriteLine($"–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è: {ex.Message}");
                }

                OnPropertyChanged(nameof(AllNotifications));
                OnPropertyChanged(nameof(UserNotifications));
            });
        }

        private void AddPersonalNotification(string message)
        {
            Application.Current?.Dispatcher?.Invoke(() =>
            {
                var notification = new Notification
                {
                    Message = message,
                    Time = DateTime.Now,
                    UserId = CurrentUser?.Id ?? "",
                    UserName = CurrentUser?.Name ?? "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á"
                };
                AllNotifications.Insert(0, notification);

                try
                {
                    _localDataService.AddNotification(notification);
                }
                catch (Exception ex)
                {
                    System.Diagnostics.Debug.WriteLine($"–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è: {ex.Message}");
                }

                OnPropertyChanged(nameof(AllNotifications));
                OnPropertyChanged(nameof(UserNotifications));
            });
        }

        public void SendHelpRequest()
        {
            if (CurrentUser == null) return;

            _userReminderCounts[CurrentUser.Id] = 0;
            CurrentUser.Status = UserStatus.Help;

            AddNotification($"{CurrentUser.Name} –Ω–∞–¥—ñ—Å–ª–∞–≤ –∑–∞–ø–∏—Ç –Ω–∞ –î–û–ü–û–ú–û–ì–£! –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –±—É–¥–µ —á–µ—Ä–µ–∑ 3 —Ö–≤–∏–ª–∏–Ω–∏.");

            if (!CurrentUser.IsLeader)
            {
                AddPersonalNotification($"–í–∏ –Ω–∞–¥—ñ—Å–ª–∞–ª–∏ –∑–∞–ø–∏—Ç –Ω–∞ –î–û–ü–û–ú–û–ì–£! –û—á—ñ–∫—É–π—Ç–µ –Ω–∞ –¥–æ–ø–æ–º–æ–≥—É.");
            }

            MapUpdateRequested?.Invoke();

            try
            {
                _localDataService.SaveUser(CurrentUser);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: {ex.Message}");
            }
        }

        public void SendStopRequest()
        {
            if (CurrentUser == null) return;

            _userReminderCounts[CurrentUser.Id] = 0;
            CurrentUser.Status = UserStatus.Stop;

            AddNotification($"{CurrentUser.Name} –Ω–∞–¥—ñ—Å–ª–∞–≤ –∑–∞–ø–∏—Ç –Ω–∞ –ó–£–ü–ò–ù–ö–£! –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è –±—É–¥–µ —á–µ—Ä–µ–∑ 3 —Ö–≤–∏–ª–∏–Ω–∏.");

            if (!CurrentUser.IsLeader)
            {
                AddPersonalNotification($"–í–∏ –Ω–∞–¥—ñ—Å–ª–∞–ª–∏ –∑–∞–ø–∏—Ç –Ω–∞ –ó–£–ü–ò–ù–ö–£! –ì—Ä—É–ø–∞ –∑—É–ø–∏–Ω–∏—Ç—å—Å—è.");
            }

            MapUpdateRequested?.Invoke();

            try
            {
                _localDataService.SaveUser(CurrentUser);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: {ex.Message}");
            }
        }

        public void SendHelpStatus() => SendHelpRequest();
        public void SendStopStatus() => SendStopRequest();

        private void GpsTimer_Elapsed(object sender, ElapsedEventArgs e)
        {
            try
            {
                Application.Current?.Dispatcher?.Invoke(() =>
                {
                    foreach (var u in Users)
                    {
                        MoveRandomNearRoute(u);

                        var dist = DistanceToRoute(u.CurrentLocation, CurrentTrip.Route);
                        if (dist > 0.15 && _showNotifications)
                        {
                            AddNotification($"{u.Name} –≤—ñ–¥—Ö–∏–ª–∏–≤—Å—è –≤—ñ–¥ –º–∞—Ä—à—Ä—É—Ç—É ({dist:F2} km).");
                        }
                    }
                    MapUpdateRequested?.Invoke();
                });
            }
            catch (Exception ex)
            {
                if (_showNotifications)
                    Application.Current?.Dispatcher?.Invoke(() =>
                        AddNotification($"–ü–æ–º–∏–ª–∫–∞ GPS-—ñ–º—ñ—Ç–∞—Ü—ñ—ó: {ex.Message}"));
            }
        }

        private void MoveRandomNearRoute(User user)
        {
            if (!CurrentTrip.Route.Any()) return;

            var closestPoint = CurrentTrip.Route.OrderBy(p => HaversineDistanceKm(user.CurrentLocation, p)).First();

            double deviationKm = _rnd.NextDouble() * MaxDeviationKm;
            double angle = _rnd.NextDouble() * 2 * Math.PI;

            double latOffset = (deviationKm / 111.0) * Math.Cos(angle);
            double lonOffset = (deviationKm / (111.0 * Math.Cos(closestPoint.Latitude * Math.PI / 180.0))) * Math.Sin(angle);

            double newLat = closestPoint.Latitude + latOffset;
            double newLon = closestPoint.Longitude + lonOffset;

            double noiseMeters = GaussianRandom(_rnd, 0, GpsNoiseMeters);
            var (latNoise, lonNoise) = MetersToLatLonOffset(noiseMeters, noiseMeters, newLat);
            newLat += latNoise;
            newLon += lonNoise;

            user.CurrentLocation = new Location(newLat, newLon);

            try
            {
                _localDataService.SaveUser(user);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: {ex.Message}");
            }
        }

        private double GaussianRandom(Random rand, double mean, double stdDev)
        {
            double u1 = 1.0 - rand.NextDouble();
            double u2 = 1.0 - rand.NextDouble();
            double randStdNormal = Math.Sqrt(-2.0 * Math.Log(u1)) * Math.Sin(2.0 * Math.PI * u2);
            return mean + stdDev * randStdNormal;
        }

        private (double latOffset, double lonOffset) MetersToLatLonOffset(double metersLat, double metersLon, double latitude)
        {
            const double EarthRadius = 6371000;
            double latOffset = (metersLat / EarthRadius) * (180.0 / Math.PI);
            double lonOffset = (metersLon / (EarthRadius * Math.Cos(latitude * Math.PI / 180.0))) * (180.0 / Math.PI);
            return (latOffset, lonOffset);
        }

        private double DistanceToRoute(Location loc, ObservableCollection<Location> route)
        {
            if (route == null || !route.Any()) return double.MaxValue;
            return route.Min(r => HaversineDistanceKm(loc, r));
        }

        private double HaversineDistanceKm(Location a, Location b)
        {
            double R = 6371;
            double dLat = ToRad(b.Latitude - a.Latitude);
            double dLon = ToRad(b.Longitude - a.Longitude);
            double lat1 = ToRad(a.Latitude);
            double lat2 = ToRad(b.Latitude);
            double sinDlat = Math.Sin(dLat / 2);
            double sinDlon = Math.Sin(dLon / 2);
            double aa = sinDlat * sinDlat + sinDlon * sinDlon * Math.Cos(lat1) * Math.Cos(lat2);
            double c = 2 * Math.Atan2(Math.Sqrt(aa), Math.Sqrt(1 - aa));
            return R * c;
        }

        private double ToRad(double deg) => deg * Math.PI / 180.0;

        public void EndTrip()
        {
            _gpsTimer.Stop();
            _statusReminderTimer.Stop();
            _dataRefreshTimer.Stop();
            AddNotification("–ü–æ–¥–æ—Ä–æ–∂ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.");
        }

        public async void UpdateTripPlan(string duration, string breakSchedule, ObservableCollection<string> restPlaces, ObservableCollection<string> pointsOfInterest)
        {
            try
            {
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ω–æ–≤–∏–π –º–µ—Ç–æ–¥ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö
                var success = await UpdateTripPlanAsync(duration, breakSchedule, restPlaces, pointsOfInterest);

                if (success)
                {
                    // –õ–æ–∫–∞–ª—å–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–∂–µ –≤–∏–∫–æ–Ω–∞–Ω–æ –≤ UpdateTripPlanAsync
                    System.Diagnostics.Debug.WriteLine("‚úÖ –ü–ª–∞–Ω –ø–æ–¥–æ—Ä–æ–∂—ñ –æ–Ω–æ–≤–ª–µ–Ω–æ —Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö");
                }
                else
                {
                    AddNotification("‚ö†Ô∏è –ü–ª–∞–Ω –ø–æ–¥–æ—Ä–æ–∂—ñ –æ–Ω–æ–≤–ª–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ, –∞–ª–µ –Ω–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö");
                }

                OnPropertyChanged(nameof(CurrentTrip));
            }
            catch (Exception ex)
            {
                AddNotification($"‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–ª–∞–Ω—É –ø–æ–¥–æ—Ä–æ–∂—ñ: {ex.Message}");
            }
        }

        public void AddUser(User u)
        {
            try
            {
                Users.Add(u);
                _localDataService.SaveUser(u);
                AddNotification($"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á {u.Name} –¥–æ–¥–∞–Ω–∏–π");
            }
            catch (Exception ex)
            {
                AddNotification($"–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: {ex.Message}");
            }
        }

        public void DeleteUser(string userName)
        {
            try
            {
                var userToDelete = Users.FirstOrDefault(u => u.Name == userName);
                if (userToDelete != null)
                {
                    Users.Remove(userToDelete);
                    LoadData();
                    AddNotification($"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {userName} –≤–∏–¥–∞–ª–µ–Ω–æ");
                }
            }
            catch (Exception ex)
            {
                AddNotification($"–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: {ex.Message}");
            }
        }

        public void LoadData()
        {
            LoadDataFromService();
        }

        public void ClearRoute()
        {
            CurrentTrip.Route.Clear();

            try
            {
                _localDataService.UpdateTrip(CurrentTrip);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"–ü–æ–º–∏–ª–∫–∞ –æ—á–∏—â–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É: {ex.Message}");
            }

            AddNotification("–ú–∞—Ä—à—Ä—É—Ç –æ—á–∏—â–µ–Ω–æ.");
        }

        public void SetManualRoute()
        {
            try
            {
                System.Diagnostics.Debug.WriteLine("üéØ SetManualRoute –≤–∏–∫–ª–∏–∫–∞–Ω–æ");

                ClearRoute();
                CurrentTrip.TripName = "–†—É—á–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç";
                CurrentTrip.Duration = "–ù–µ –≤–∫–∞–∑–∞–Ω–æ";
                CurrentTrip.BreakSchedule = "–ù–µ –≤–∫–∞–∑–∞–Ω–æ";
                CurrentTrip.RestPlaces.Clear();
                CurrentTrip.PointsOfInterest.Clear();
                CurrentTrip.IsActive = true;

                OnPropertyChanged(nameof(CurrentTrip));
                OnPropertyChanged(nameof(CurrentTrip.TripName));

                AddNotification("–û–±—Ä–∞–Ω–æ —Ä—É—á–Ω–µ –ø—Ä–æ–∫–ª–∞–¥–∞–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—É");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"üí• –ü–æ–º–∏–ª–∫–∞ –≤ SetManualRoute: {ex.Message}");
                AddNotification($"‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä—É—á–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É: {ex.Message}");
            }
        }

        private void RelocateUsersToRouteStart()
        {
            if (!CurrentTrip.Route.Any()) return;
            var startPoint = CurrentTrip.Route.First();
            foreach (var user in Users)
            {
                user.CurrentLocation = new Location(startPoint.Latitude, startPoint.Longitude);

                try
                {
                    _localDataService.SaveUser(user);
                }
                catch (Exception ex)
                {
                    System.Diagnostics.Debug.WriteLine($"–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: {ex.Message}");
                }
            }
        }

        public event PropertyChangedEventHandler PropertyChanged;
        protected void OnPropertyChanged(string propertyName)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }
    }
}






-------------------------------------------------------------------



–ü–ê–ü–ö–ê Views
=================================



FeedbackWindow.xaml
====


<Window x:Class="TrackingApp.Views.FeedbackWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="–ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫" Height="350" Width="400"
        MinHeight="300" MinWidth="400"
        WindowStartupLocation="CenterScreen"
        Closing="Window_Closing">
    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <TextBlock Grid.Row="0" Text="–ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫" 
                   FontWeight="Bold" FontSize="18" 
                   HorizontalAlignment="Center" Margin="0,0,0,15"/>

        <!-- –í–∞—à –≤—ñ–¥–≥—É–∫ -->
        <TextBlock Grid.Row="1" Text="–í–∞—à –≤—ñ–¥–≥—É–∫:" 
                   FontWeight="SemiBold" Margin="0,0,0,5"/>

        <TextBox Grid.Row="2" x:Name="TxtFeedback" 
                 Margin="0,0,0,15" Padding="8" 
                 AcceptsReturn="True" TextWrapping="Wrap" 
                 VerticalScrollBarVisibility="Auto"
                 MinHeight="80"/>

        <!-- –†–µ–π—Ç–∏–Ω–≥ -->
        <TextBlock Grid.Row="3" Text="–†–µ–π—Ç–∏–Ω–≥ (1-5):" 
                   FontWeight="SemiBold" Margin="0,0,0,5"/>

        <TextBox Grid.Row="4" x:Name="TxtRating" 
                 Margin="0,0,0,20" Padding="8" 
                 MaxLength="1" 
                 VerticalContentAlignment="Center"/>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <StackPanel Grid.Row="5" Orientation="Horizontal" 
                    HorizontalAlignment="Right" Margin="0,10,0,0">
            <Button x:Name="BtnOk" Click="BtnOk_Click" 
                    Width="100" Height="32" Margin="0,0,10,0"
                    Content="–ù–∞–¥—ñ—Å–ª–∞—Ç–∏" FontWeight="SemiBold"/>
            <Button x:Name="BtnCancel" Click="BtnCancel_Click" 
                    Width="100" Height="32"
                    Content="–°–∫–∞—Å—É–≤–∞—Ç–∏"/>
        </StackPanel>
    </Grid>
</Window>




------------------------------------------------------------------------------




FeedbackWindow.xaml.cs
===


using System;
using System.Windows;
using System.Threading.Tasks;
using TrackingApp.ViewModels;

namespace TrackingApp.Views
{
    public partial class FeedbackWindow : Window
    {
        public string FeedbackText { get; private set; }
        public int Rating { get; private set; }

        private readonly MainViewModel _viewModel;
        private bool _isProcessing = false;

        public FeedbackWindow(MainViewModel viewModel)
        {
            InitializeComponent();
            _viewModel = viewModel;

            // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä—à–æ–º—É –ø–æ–ª—ñ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ
            Loaded += (s, e) => TxtFeedback.Focus();
        }

        private async void BtnOk_Click(object sender, RoutedEventArgs e)
        {
            // –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—é
            if (_isProcessing)
                return;

            _isProcessing = true;
            BtnOk.IsEnabled = false;
            BtnCancel.IsEnabled = false;
            BtnOk.Content = "–í—ñ–¥–ø—Ä–∞–≤–∫–∞...";

            try
            {
                // –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∑ –ø–æ–ª—ñ–≤
                FeedbackText = TxtFeedback.Text.Trim();
                var ratingText = TxtRating.Text.Trim();

                // –í–∞–ª—ñ–¥–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö
                if (string.IsNullOrEmpty(FeedbackText))
                {
                    MessageBox.Show("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –≤–∞—à –≤—ñ–¥–≥—É–∫!", "–ü–æ–º–∏–ª–∫–∞",
                                  MessageBoxButton.OK, MessageBoxImage.Warning);
                    return;
                }

                if (string.IsNullOrEmpty(ratingText))
                {
                    MessageBox.Show("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —Ä–µ–π—Ç–∏–Ω–≥!", "–ü–æ–º–∏–ª–∫–∞",
                                  MessageBoxButton.OK, MessageBoxImage.Warning);
                    return;
                }

                if (!int.TryParse(ratingText, out int rating) || rating < 1 || rating > 5)
                {
                    MessageBox.Show("–†–µ–π—Ç–∏–Ω–≥ –º–∞—î –±—É—Ç–∏ —á–∏—Å–ª–æ–º –≤—ñ–¥ 1 –¥–æ 5!", "–ü–æ–º–∏–ª–∫–∞",
                                  MessageBoxButton.OK, MessageBoxImage.Warning);
                    return;
                }

                Rating = rating;

                // –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
                System.Diagnostics.Debug.WriteLine($"üì§ –ü–æ—á–∞—Ç–æ–∫ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –≤—ñ–¥–≥—É–∫—É...");

                // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –≤—ñ–¥–≥—É–∫—É
                var success = await _viewModel.SendFeedbackAsync(FeedbackText, Rating);

                System.Diagnostics.Debug.WriteLine($"üì§ –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ñ–¥–ø—Ä–∞–≤–∫–∏: {success}");

                if (success)
                {
                    System.Diagnostics.Debug.WriteLine("‚úÖ –í—ñ–¥–≥—É–∫ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ, –∑–∞–∫—Ä–∏–≤–∞—î–º–æ –≤—ñ–∫–Ω–æ");

                    // –ó–ê–ö–†–ò–í–ê–Ñ–ú–û –í–Ü–ö–ù–û –ü–Ü–°–õ–Ø –£–°–ü–Ü–®–ù–û–á –í–Ü–î–ü–†–ê–í–ö–ò
                    this.DialogResult = true;
                    this.Close(); // –Ø–í–ù–ï –ó–ê–ö–†–ò–¢–¢–Ø –í–Ü–ö–ù–ê
                }
                else
                {
                    System.Diagnostics.Debug.WriteLine("‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –≤—ñ–¥–≥—É–∫—É");
                    MessageBox.Show("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤—ñ–¥–≥—É–∫. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.",
                                  "–ü–æ–º–∏–ª–∫–∞", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"üí• –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞: {ex.Message}");
                MessageBox.Show($"–°—Ç–∞–ª–∞—Å—è –Ω–µ—Å–ø–æ–¥—ñ–≤–∞–Ω–∞ –ø–æ–º–∏–ª–∫–∞: {ex.Message}",
                              "–ü–æ–º–∏–ª–∫–∞", MessageBoxButton.OK, MessageBoxImage.Error);
            }
            finally
            {
                // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω –∫–Ω–æ–ø–æ–∫
                _isProcessing = false;
                BtnOk.IsEnabled = true;
                BtnCancel.IsEnabled = true;
                BtnOk.Content = "–ù–∞–¥—ñ—Å–ª–∞—Ç–∏";
            }
        }

        private void BtnCancel_Click(object sender, RoutedEventArgs e)
        {
            if (_isProcessing) return;

            this.DialogResult = false;
            this.Close();
        }

        private void Window_Closing(object sender, System.ComponentModel.CancelEventArgs e)
        {
            // –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ –∑–∞–∫—Ä–∏—Ç—Ç—é –ø—ñ–¥ —á–∞—Å –æ–±—Ä–æ–±–∫–∏
            if (_isProcessing)
            {
                e.Cancel = true;
            }
        }
    }
}




--------------------------------------------------------------



LoginWindow.xaml
====




<Window x:Class="TrackingApp.Views.LoginWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="–í—Ö—ñ–¥ —É —Å–∏—Å—Ç–µ–º—É" Height="600" Width="400"
        WindowStartupLocation="CenterScreen"
        KeyDown="Window_KeyDown">
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- –°—Ç–∞—Ç—É—Å –∑'—î–¥–Ω–∞–Ω–Ω—è -->
            <RowDefinition Height="Auto"/>
            <!-- –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è -->
            <RowDefinition Height="Auto"/>
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <RowDefinition Height="Auto"/>
            <!-- –Ü–º'—è –ª–µ–π–±–ª -->
            <RowDefinition Height="Auto"/>
            <!-- –Ü–º'—è –ø–æ–ª–µ -->
            <RowDefinition Height="Auto"/>
            <!-- –ü–∞—Ä–æ–ª—å –ª–µ–π–±–ª -->
            <RowDefinition Height="Auto"/>
            <!-- –ü–∞—Ä–æ–ª—å –ø–æ–ª–µ -->
            <RowDefinition Height="Auto"/>
            <!-- Email –ª–µ–π–±–ª -->
            <RowDefinition Height="Auto"/>
            <!-- Email –ø–æ–ª–µ -->
            <RowDefinition Height="Auto"/>
            <!-- –¢–∏–ø –ø–æ–¥–æ—Ä–æ–∂—ñ –ª–µ–π–±–ª (—Ç—ñ–ª—å–∫–∏ –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó) -->
            <RowDefinition Height="Auto"/>
            <!-- –¢–∏–ø –ø–æ–¥–æ—Ä–æ–∂—ñ –ø–æ–ª–µ (—Ç—ñ–ª—å–∫–∏ –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó) -->
            <RowDefinition Height="Auto"/>
            <!-- –ü—Ä–æ–º—ñ–∂–Ω–∏–π –≤—ñ–¥—Å—Ç—É–ø -->
            <RowDefinition Height="Auto"/>
            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <RowDefinition Height="*"/>
            <!-- –ó–∞–ø–æ–≤–Ω—é–≤–∞—á -->
        </Grid.RowDefinitions>

        <!-- –°—Ç–∞—Ç—É—Å –∑'—î–¥–Ω–∞–Ω–Ω—è -->
        <TextBlock x:Name="StatusText" Grid.Row="0" 
                   Text="–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è..." 
                   HorizontalAlignment="Center" 
                   Margin="0,0,0,10"
                   FontSize="11"
                   FontWeight="SemiBold"
                   Visibility="Collapsed"
                   TextWrapping="Wrap"
                   TextAlignment="Center"/>

        <!-- –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è -->
        <Image Grid.Row="1" 
               Source="https://drive.google.com/uc?export=view&amp;id=1skdeUtcXvdTaGcnNSNyElYTh1TpXRBBo" 
               Width="120" Height="120" 
               HorizontalAlignment="Center" 
               Margin="0,0,0,20" 
               Stretch="Uniform" />

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <TextBlock Grid.Row="2" 
                   Text="–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è / –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è" 
                   FontWeight="Bold" 
                   FontSize="18" 
                   HorizontalAlignment="Center"
                   Margin="0,0,0,20"/>

        <!-- –õ–µ–π–±–ª –Ü–º'—è -->
        <TextBlock Grid.Row="3" 
                   Text="–Ü–º'—è:" 
                   FontWeight="SemiBold" 
                   Margin="0,10,0,5"/>

        <!-- –ü–æ–ª–µ –Ü–º'—è -->
        <TextBox Grid.Row="4" 
                 x:Name="TxtName" 
                 Margin="0,0,0,10"
                 VerticalContentAlignment="Center"
                 Padding="5"
                 KeyDown="TxtName_KeyDown"/>

        <!-- –õ–µ–π–±–ª –ü–∞—Ä–æ–ª—å -->
        <TextBlock Grid.Row="5" 
                   Text="–ü–∞—Ä–æ–ª—å:" 
                   FontWeight="SemiBold" 
                   Margin="0,10,0,5"/>

        <!-- –ü–æ–ª–µ –ü–∞—Ä–æ–ª—å -->
        <PasswordBox Grid.Row="6" 
                     x:Name="TxtPassword" 
                     Margin="0,0,0,10"
                     VerticalContentAlignment="Center"
                     Padding="5"
                     KeyDown="TxtPassword_KeyDown"/>

        <!-- –õ–µ–π–±–ª Email -->
        <TextBlock Grid.Row="7" 
                   Text="Email:" 
                   FontWeight="SemiBold" 
                   Margin="0,10,0,5"/>

        <!-- –ü–æ–ª–µ Email -->
        <TextBox Grid.Row="8" 
                 x:Name="TxtEmail" 
                 Margin="0,0,0,10"
                 VerticalContentAlignment="Center"
                 Padding="5"
                 KeyDown="TxtEmail_KeyDown"/>

        <!-- –õ–µ–π–±–ª –¢–∏–ø –ø–æ–¥–æ—Ä–æ–∂—ñ (—Ç—ñ–ª—å–∫–∏ –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó) -->
        <TextBlock Grid.Row="9" 
                   Text="–¢–∏–ø –ø–æ–¥–æ—Ä–æ–∂—ñ:" 
                   FontWeight="SemiBold" 
                   Margin="0,10,0,5"
                   Visibility="{Binding IsRegisterMode, Converter={StaticResource BooleanToVisibilityConverter}}"/>

        <!-- –ü–æ–ª–µ –¢–∏–ø –ø–æ–¥–æ—Ä–æ–∂—ñ (—Ç—ñ–ª—å–∫–∏ –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó) -->
        <ComboBox Grid.Row="10" 
                  x:Name="CmbTripType" 
                  Margin="0,0,0,10"
                  VerticalContentAlignment="Center"
                  Visibility="{Binding IsRegisterMode, Converter={StaticResource BooleanToVisibilityConverter}}"
                  KeyDown="CmbTripType_KeyDown">
            <ComboBoxItem Content="–ü—ñ—à–∞"/>
            <ComboBoxItem Content="–í–µ–ª–æ-–ø–æ–¥–æ—Ä–æ–∂"/>
            <ComboBoxItem Content="–ï–∫—Å–∫—É—Ä—Å—ñ—è"/>
        </ComboBox>

        <!-- –ü—Ä–æ–º—ñ–∂–Ω–∏–π –≤—ñ–¥—Å—Ç—É–ø -->
        <Border Grid.Row="11" Height="20"/>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <StackPanel Grid.Row="12" 
                    Orientation="Horizontal" 
                    HorizontalAlignment="Center" 
                    VerticalAlignment="Center"
                    Margin="0,0,0,10">
            <Button x:Name="BtnToggleMode" 
                    Content="–î–æ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó" 
                    Click="BtnToggleMode_Click" 
                    Style="{StaticResource SecondaryButton}" 
                    Width="140" 
                    Height="40"
                    Margin="0,0,10,0"/>
            <Button x:Name="BtnSubmit" 
                    Content="–£–≤—ñ–π—Ç–∏" 
                    Click="BtnSubmit_Click" 
                    Style="{StaticResource PrimaryButton}" 
                    Width="140" 
                    Height="40"/>
        </StackPanel>
    </Grid>
</Window>





--------------------------------------------------------



LoginWindow.xaml.cs
===



using System.Linq;
using System.Windows;
using System.Windows.Controls;
using TrackingApp.Models;
using TrackingApp.ViewModels;
using TrackingApp.Services;
using TrackingApp.Config;

namespace TrackingApp.Views
{
    public partial class LoginWindow : Window, System.ComponentModel.INotifyPropertyChanged
    {
        private readonly MainViewModel _vm;
        private bool _isRegisterMode;
        private bool _loginSuccessful = false;

        public bool IsRegisterMode
        {
            get => _isRegisterMode;
            set
            {
                _isRegisterMode = value;
                OnPropertyChanged(nameof(IsRegisterMode));
                BtnToggleMode.Content = _isRegisterMode ? "–î–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó" : "–î–æ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó";
                BtnSubmit.Content = _isRegisterMode ? "–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è" : "–£–≤—ñ–π—Ç–∏";
            }
        }

        public LoginWindow(MainViewModel vm)
        {
            InitializeComponent();
            _vm = vm;
            DataContext = this;
            IsRegisterMode = false;

            Loaded += LoginWindow_Loaded;
        }

        private async void LoginWindow_Loaded(object sender, RoutedEventArgs e)
        {
            System.Diagnostics.Debug.WriteLine("=== –î–Ü–ê–ì–ù–û–°–¢–ò–ö–ê –ü–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø ===");
            System.Diagnostics.Debug.WriteLine($"üìç –ß–∞—Å –ø–æ—á–∞—Ç–∫—É: {System.DateTime.Now:HH:mm:ss}");

            AppConfig.LogConfiguration();

            if (AppConfig.UseServerMode)
            {
                StatusText.Visibility = Visibility.Visible;
                StatusText.Text = "üîÑ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º...";
                StatusText.Foreground = System.Windows.Media.Brushes.Orange;

                System.Diagnostics.Debug.WriteLine($"üìç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ TCP –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ: {AppConfig.ServerHost}:{AppConfig.ServerPort}");

                var trackingService = new TrackingService();
                bool isConnected = await trackingService.CheckServerConnectionAsync();

                if (!isConnected)
                {
                    StatusText.Text = "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞";
                    StatusText.Foreground = System.Windows.Media.Brushes.Red;

                    System.Diagnostics.Debug.WriteLine("‚ùå –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ –≤–¥–∞–ª–æ—Å—è");

                    var result = MessageBox.Show(
                        "‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞.\n\n" +
                        "–ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:\n" +
                        "‚Ä¢ –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω–∏–π\n" +
                        "‚Ä¢ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ö–æ—Å—Ç –∞–±–æ –ø–æ—Ä—Ç\n" +
                        "‚Ä¢ –§–∞—î—Ä–≤–æ–ª –±–ª–æ–∫—É—î –∑'—î–¥–Ω–∞–Ω–Ω—è\n" +
                        "‚Ä¢ –ü–æ—Ä—Ç –∑–∞–π–Ω—è—Ç–∏–π\n\n" +
                        "–ë–∞–∂–∞—î—Ç–µ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ?",
                        "–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è",
                        MessageBoxButton.YesNo,
                        MessageBoxImage.Warning);

                    if (result == MessageBoxResult.Yes)
                    {
                        System.Diagnostics.Debug.WriteLine("üîß –ü–µ—Ä–µ—Ö—ñ–¥ –≤ –ª–æ–∫–∞–ª—å–Ω–∏–π —Ä–µ–∂–∏–º");
                        AppConfig.UseServerMode = false;
                        StatusText.Text = "üîß –õ–æ–∫–∞–ª—å–Ω–∏–π —Ä–µ–∂–∏–º";
                        StatusText.Foreground = System.Windows.Media.Brushes.Blue;
                    }
                    else
                    {
                        System.Diagnostics.Debug.WriteLine("üö™ –ó–∞–∫—Ä–∏—Ç—Ç—è –¥–æ–¥–∞—Ç–∫—É —á–µ—Ä–µ–∑ –ø–æ–º–∏–ª–∫—É –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è");
                        Close();
                        return;
                    }
                }
                else
                {
                    StatusText.Text = "‚úÖ –£—Å–ø—ñ—à–Ω–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ —Å–µ—Ä–≤–µ—Ä–∞";
                    StatusText.Foreground = System.Windows.Media.Brushes.Green;

                    System.Diagnostics.Debug.WriteLine("‚úÖ –£—Å–ø—ñ—à–Ω–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ —Å–µ—Ä–≤–µ—Ä–∞");

                    MessageBox.Show(
                        "‚úÖ –£—Å–ø—ñ—à–Ω–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ —Å–µ—Ä–≤–µ—Ä–∞!\n\n" +
                        "–¢–µ–ø–µ—Ä –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –≤—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–æ–¥–∞—Ç–∫—É.",
                        "–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è",
                        MessageBoxButton.OK,
                        MessageBoxImage.Information);
                }

                await System.Threading.Tasks.Task.Delay(3000);
                StatusText.Visibility = Visibility.Collapsed;
            }
            else
            {
                StatusText.Visibility = Visibility.Visible;
                StatusText.Text = "üîß –õ–æ–∫–∞–ª—å–Ω–∏–π —Ä–µ–∂–∏–º";
                StatusText.Foreground = System.Windows.Media.Brushes.Blue;

                System.Diagnostics.Debug.WriteLine("üîß –õ–æ–∫–∞–ª—å–Ω–∏–π —Ä–µ–∂–∏–º - —Å–µ—Ä–≤–µ—Ä –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è");

                await System.Threading.Tasks.Task.Delay(2000);
                StatusText.Visibility = Visibility.Collapsed;
            }

            System.Diagnostics.Debug.WriteLine($"üìç –ß–∞—Å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è: {System.DateTime.Now:HH:mm:ss}");
            System.Diagnostics.Debug.WriteLine("=== –ö–Ü–ù–ï–¶–¨ –î–Ü–ê–ì–ù–û–°–¢–ò–ö–ò ===");
        }

        private async void BtnSubmit_Click(object sender, RoutedEventArgs e)
        {
            var name = TxtName.Text?.Trim() ?? string.Empty;
            var password = TxtPassword.Password?.Trim() ?? string.Empty;
            var email = TxtEmail.Text?.Trim() ?? string.Empty;

            System.Diagnostics.Debug.WriteLine($"üîê –°–ø—Ä–æ–±–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó/—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó:");
            System.Diagnostics.Debug.WriteLine($"   –†–µ–∂–∏–º: {(IsRegisterMode ? "–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è" : "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è")}");
            System.Diagnostics.Debug.WriteLine($"   –Ü–º'—è: {name}");
            System.Diagnostics.Debug.WriteLine($"   Email: {email}");
            System.Diagnostics.Debug.WriteLine($"   –î–æ–≤–∂–∏–Ω–∞ –ø–∞—Ä–æ–ª—è: {password.Length}");

            if (string.IsNullOrEmpty(name))
            {
                System.Diagnostics.Debug.WriteLine("‚ùå –ü–æ–º–∏–ª–∫–∞: –Ω–µ –≤–≤–µ–¥–µ–Ω–æ —ñ–º'—è");
                MessageBox.Show("–í–≤–µ–¥—ñ—Ç—å —ñ–º'—è!", "–ü–æ–º–∏–ª–∫–∞", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            if (string.IsNullOrEmpty(email))
            {
                System.Diagnostics.Debug.WriteLine("‚ùå –ü–æ–º–∏–ª–∫–∞: –Ω–µ –≤–≤–µ–¥–µ–Ω–æ email");
                MessageBox.Show("–ü–æ–ª–µ email –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–º!", "–ü–æ–º–∏–ª–∫–∞", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            if (string.IsNullOrEmpty(password))
            {
                System.Diagnostics.Debug.WriteLine("‚ùå –ü–æ–º–∏–ª–∫–∞: –Ω–µ –≤–≤–µ–¥–µ–Ω–æ –ø–∞—Ä–æ–ª—å");
                MessageBox.Show("–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å!", "–ü–æ–º–∏–ª–∫–∞", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            if (password.Length < 3)
            {
                System.Diagnostics.Debug.WriteLine("‚ùå –ü–æ–º–∏–ª–∫–∞: –ø–∞—Ä–æ–ª—å –∑–∞–Ω–∞–¥—Ç–æ –∫–æ—Ä–æ—Ç–∫–∏–π");
                MessageBox.Show("–ü–∞—Ä–æ–ª—å –∑–∞–Ω–∞–¥—Ç–æ –∫–æ—Ä–æ—Ç–∫–∏–π! –ú—ñ–Ω—ñ–º—É–º 3 —Å–∏–º–≤–æ–ª–∏.", "–ü–æ–º–∏–ª–∫–∞", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            // –û–ì–û–õ–û–®–£–Ñ–ú–û trackingService –¢–Ü–õ–¨–ö–ò –û–î–ò–ù –†–ê–ó
            var trackingService = new TrackingService();

            if (IsRegisterMode)
            {
                // –†–ï–Ñ–°–¢–†–ê–¶–Ü–Ø
                System.Diagnostics.Debug.WriteLine("üìù –ü—Ä–æ—Ü–µ—Å —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó...");

                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ —ñ—Å–Ω—É—î —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä
                try
                {
                    var existingUsers = await trackingService.GetUsersAsync();
                    if (existingUsers.Any(u => u.Name == name))
                    {
                        System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞: –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á {name} –≤–∂–µ —ñ—Å–Ω—É—î");
                        MessageBox.Show("–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ —Ç–∞–∫–∏–º —ñ–º'—è–º —É–∂–µ —ñ—Å–Ω—É—î!", "–ü–æ–º–∏–ª–∫–∞", MessageBoxButton.OK, MessageBoxImage.Warning);
                        return;
                    }
                }
                catch (Exception ex)
                {
                    System.Diagnostics.Debug.WriteLine($"‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: {ex.Message}");
                }

                bool isAdmin = email.EndsWith("@admin.com");
                string requiredDomain = isAdmin ? "@admin.com" : "@example.com";

                if (!email.EndsWith(requiredDomain))
                {
                    System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞: email –º–∞—î –∑–∞–∫—ñ–Ω—á—É–≤–∞—Ç–∏—Å—è –Ω–∞ {requiredDomain}");
                    MessageBox.Show($"Email –º–∞—î –∑–∞–∫—ñ–Ω—á—É–≤–∞—Ç–∏—Å—è –Ω–∞ {requiredDomain}!", "–ü–æ–º–∏–ª–∫–∞", MessageBoxButton.OK, MessageBoxImage.Warning);
                    return;
                }

                if (CmbTripType.SelectedItem == null)
                {
                    System.Diagnostics.Debug.WriteLine("‚ùå –ü–æ–º–∏–ª–∫–∞: –Ω–µ –≤–∏–±—Ä–∞–Ω–æ —Ç–∏–ø –ø–æ–¥–æ—Ä–æ–∂—ñ");
                    MessageBox.Show("–í–∏–±–µ—Ä—ñ—Ç—å —Ç–∏–ø –ø–æ–¥–æ—Ä–æ–∂—ñ!", "–ü–æ–º–∏–ª–∫–∞", MessageBoxButton.OK, MessageBoxImage.Warning);
                    return;
                }

                var selectedTripType = (CmbTripType.SelectedItem as ComboBoxItem)?.Content.ToString();
                TripType tripType;
                switch (selectedTripType)
                {
                    case "–ü—ñ—à–∞":
                        tripType = TripType.Walking;
                        break;
                    case "–í–µ–ª–æ-–ø–æ–¥–æ—Ä–æ–∂":
                        tripType = TripType.Cycling;
                        break;
                    case "–ï–∫—Å–∫—É—Ä—Å—ñ—è":
                        tripType = TripType.Excursion;
                        break;
                    default:
                        System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞: –Ω–µ–≤—ñ—Ä–Ω–∏–π —Ç–∏–ø –ø–æ–¥–æ—Ä–æ–∂—ñ: {selectedTripType}");
                        MessageBox.Show("–ù–µ–≤—ñ—Ä–Ω–∏–π —Ç–∏–ø –ø–æ–¥–æ—Ä–æ–∂—ñ!", "–ü–æ–º–∏–ª–∫–∞", MessageBoxButton.OK, MessageBoxImage.Warning);
                        return;
                }

                System.Diagnostics.Debug.WriteLine($"‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:");
                System.Diagnostics.Debug.WriteLine($"   –¢–∏–ø –ø–æ–¥–æ—Ä–æ–∂—ñ: {tripType}");
                System.Diagnostics.Debug.WriteLine($"   –†–æ–ª—å: {(isAdmin ? "–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä" : "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á")}");

                var newUser = new User
                {
                    Name = name,
                    Password = password,
                    CurrentLocation = new Location(49.8430, 24.0315),
                    IsLeader = isAdmin,
                    Email = email,
                    TripType = tripType
                };

                // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≤–∂–µ –æ–≥–æ–ª–æ—à–µ–Ω–∏–π trackingService
                var registrationSuccess = await trackingService.RegisterUserAsync(newUser, password);

                if (registrationSuccess)
                {
                    // –î–æ–¥–∞—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ –ª–æ–∫–∞–ª—å–Ω–æ—ó –∫–æ–ª–µ–∫—Ü—ñ—ó
                    _vm.AddUser(newUser);

                    System.Diagnostics.Debug.WriteLine($"‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á {name} —É—Å–ø—ñ—à–Ω–æ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö");

                    MessageBox.Show(
                        $"–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ —è–∫ {(isAdmin ? "–∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä" : "–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á")}. –¢–µ–ø–µ—Ä —É–≤—ñ–π–¥—ñ—Ç—å.",
                        "–£—Å–ø—ñ—Ö",
                        MessageBoxButton.OK,
                        MessageBoxImage.Information);

                    IsRegisterMode = false;
                    TxtPassword.Password = string.Empty;
                    System.Diagnostics.Debug.WriteLine("üìç –ü–æ–ª—è –æ—á–∏—â–µ–Ω–æ –ø—ñ—Å–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó");
                }
                else
                {
                    System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {name}");
                    MessageBox.Show(
                        "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.",
                        "–ü–æ–º–∏–ª–∫–∞",
                        MessageBoxButton.OK,
                        MessageBoxImage.Error);
                }
            }
            else
            {
                // –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Ø
                System.Diagnostics.Debug.WriteLine("üîë –ü—Ä–æ—Ü–µ—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó...");

                // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≤–∂–µ –æ–≥–æ–ª–æ—à–µ–Ω–∏–π trackingService
                var user = await trackingService.AuthenticateAsync(name, password);

                if (user != null && user.Email == email)
                {
                    System.Diagnostics.Debug.WriteLine($"‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á {name} –∑–Ω–∞–π–¥–µ–Ω–∏–π");

                    bool expectedAdmin = email.EndsWith("@admin.com");
                    if (user.IsLeader != expectedAdmin)
                    {
                        System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞: –Ω–µ–≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å —Ä–æ–ª—ñ");
                        MessageBox.Show(
                            "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π email –¥–ª—è —Ü—ñ—î—ó —Ä–æ–ª—ñ! –ê–¥–º—ñ–Ω–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å @admin.com.",
                            "–ü–æ–º–∏–ª–∫–∞",
                            MessageBoxButton.OK,
                            MessageBoxImage.Warning);
                        return;
                    }

                    _vm.CurrentUser = user;

                    // –î–æ–¥–∞—î–º–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –≤—Ö—ñ–¥
                    _vm.AddNotification($"–í–∏ —É–≤—ñ–π—à–ª–∏ —è–∫ {user.Name}");

                    System.Diagnostics.Debug.WriteLine($"‚úÖ –£—Å–ø—ñ—à–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è: {user.Name} ({(user.IsLeader ? "–ê–¥–º—ñ–Ω" : "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á")})");

                    // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–∞–ø–æ—Ä–µ—Ü—å —É—Å–ø—ñ—à–Ω–æ—ó –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
                    _loginSuccessful = true;

                    // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –≤—ñ–∫–Ω–æ
                    Close();
                }
                else
                {
                    System.Diagnostics.Debug.WriteLine("‚ùå –ü–æ–º–∏–ª–∫–∞: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–µ —ñ–º'—è, –ø–∞—Ä–æ–ª—å –∞–±–æ email");
                    MessageBox.Show(
                        "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–µ —ñ–º'—è, –ø–∞—Ä–æ–ª—å –∞–±–æ email!",
                        "–ü–æ–º–∏–ª–∫–∞",
                        MessageBoxButton.OK,
                        MessageBoxImage.Warning);
                }
            }
        }

        // –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø: –î–æ–¥–∞—î–º–æ –≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —É—Å–ø—ñ—à–Ω–æ—ó –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
        public bool LoginSuccessful => _loginSuccessful;

        private void BtnToggleMode_Click(object sender, RoutedEventArgs e)
        {
            System.Diagnostics.Debug.WriteLine($"üîÑ –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Ä–µ–∂–∏–º—É: {(IsRegisterMode ? "–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è ‚Üí –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è" : "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è ‚Üí –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è")}");

            IsRegisterMode = !IsRegisterMode;

            // –û—á–∏—â–∞—î–º–æ –ø–æ–ª—è –ø—Ä–∏ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—ñ —Ä–µ–∂–∏–º—É
            if (!IsRegisterMode)
            {
                TxtPassword.Password = string.Empty;
                System.Diagnostics.Debug.WriteLine("üìç –ü–æ–ª—è –æ—á–∏—â–µ–Ω–æ –ø—Ä–∏ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—ñ —Ä–µ–∂–∏–º—É");
            }
        }

        private void TxtPassword_KeyDown(object sender, System.Windows.Input.KeyEventArgs e)
        {
            if (e.Key == System.Windows.Input.Key.Enter)
            {
                System.Diagnostics.Debug.WriteLine("‚å®Ô∏è –ù–∞—Ç–∏—Å–Ω—É—Ç–æ Enter –≤ –ø–æ–ª—ñ –ø–∞—Ä–æ–ª—è");
                BtnSubmit_Click(sender, e);
            }
        }

        private void TxtName_KeyDown(object sender, System.Windows.Input.KeyEventArgs e)
        {
            if (e.Key == System.Windows.Input.Key.Enter)
            {
                System.Diagnostics.Debug.WriteLine("‚å®Ô∏è –ù–∞—Ç–∏—Å–Ω—É—Ç–æ Enter –≤ –ø–æ–ª—ñ —ñ–º–µ–Ω—ñ");
                if (IsRegisterMode)
                {
                    TxtEmail.Focus();
                }
                else
                {
                    TxtPassword.Focus();
                }
            }
        }

        private void TxtEmail_KeyDown(object sender, System.Windows.Input.KeyEventArgs e)
        {
            if (e.Key == System.Windows.Input.Key.Enter)
            {
                System.Diagnostics.Debug.WriteLine("‚å®Ô∏è –ù–∞—Ç–∏—Å–Ω—É—Ç–æ Enter –≤ –ø–æ–ª—ñ email");
                if (IsRegisterMode)
                {
                    CmbTripType.Focus();
                }
                else
                {
                    TxtPassword.Focus();
                }
            }
        }

        private void CmbTripType_KeyDown(object sender, System.Windows.Input.KeyEventArgs e)
        {
            if (e.Key == System.Windows.Input.Key.Enter && IsRegisterMode)
            {
                System.Diagnostics.Debug.WriteLine("‚å®Ô∏è –ù–∞—Ç–∏—Å–Ω—É—Ç–æ Enter –≤ –∫–æ–º–±–æ–±–æ–∫—Å—ñ");
                BtnSubmit_Click(sender, e);
            }
        }

        private void Window_KeyDown(object sender, System.Windows.Input.KeyEventArgs e)
        {
            if (e.Key == System.Windows.Input.Key.Escape)
            {
                System.Diagnostics.Debug.WriteLine("üö™ –ù–∞—Ç–∏—Å–Ω—É—Ç–æ Escape - –∑–∞–∫—Ä–∏—Ç—Ç—è –≤—ñ–∫–Ω–∞");
                Close();
            }
        }

        private void Window_Closing(object sender, System.ComponentModel.CancelEventArgs e)
        {
            System.Diagnostics.Debug.WriteLine($"üö™ –ó–∞–∫—Ä–∏—Ç—Ç—è LoginWindow: LoginSuccessful = {_loginSuccessful}");
        }

        public event System.ComponentModel.PropertyChangedEventHandler PropertyChanged;
        protected void OnPropertyChanged(string propertyName)
        {
            PropertyChanged?.Invoke(this, new System.ComponentModel.PropertyChangedEventArgs(propertyName));
        }
    }
}









-----------------------------------------------------


MainWindow.xaml
======



<Window x:Class="TrackingApp.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:TrackingApp.ViewModels"
        xmlns:gmap="clr-namespace:GMap.NET.WindowsPresentation;assembly=GMap.NET.WindowsPresentation"
        Title="TrackingApp ‚Äî –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –≥—Ä—É–ø–∏" Height="720" Width="1100"
        MinHeight="600" MinWidth="900"
        Loaded="Window_Loaded"
        Closing="Window_Closing">

    <Window.Resources>
        <vm:MainViewModel x:Key="MainViewModel"/>
    </Window.Resources>

    <Window.DataContext>
        <Binding Source="{StaticResource MainViewModel}"/>
    </Window.DataContext>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- –°—Ç–∞—Ç—É—Å –±–∞—Ä -->
        <Border Grid.Row="0" Background="#F0F0F0" Padding="10" BorderBrush="LightGray" BorderThickness="0,0,0,1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0" Text="TrackingApp ‚Äî –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –≥—Ä—É–ø–∏" FontWeight="Bold" FontSize="14" VerticalAlignment="Center"/>
                <TextBlock x:Name="StatusText" Grid.Column="1" 
                          Text="–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è..." 
                          VerticalAlignment="Center"
                          Margin="0,0,10,0"
                          FontSize="12"
                          FontWeight="SemiBold"
                          Foreground="Orange"/>
            </Grid>
        </Border>

        <!-- –û—Å–Ω–æ–≤–Ω–∏–π –≤–º—ñ—Å—Ç -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="320"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="320"/>
            </Grid.ColumnDefinitions>

            <!-- –õ—ñ–≤–∏–π —Å—Ç–æ–≤–ø–µ—Ü—å: –ö–µ—Ä—É–≤–∞–Ω–Ω—è –ø–æ–¥–æ—Ä–æ–∂–∂—é -->
            <Border Grid.Column="0" Margin="6" BorderBrush="LightGray" BorderThickness="1" CornerRadius="6">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="10">
                        <TextBlock Text="–ö–µ—Ä—É–≤–∞–Ω–Ω—è –ø–æ–¥–æ—Ä–æ–∂–∂—é" Style="{StaticResource HeaderText}" Margin="0,0,0,10"/>

                        <!-- –í–∏–±—ñ—Ä –º–∞—Ä—à—Ä—É—Ç—É –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
                        <TextBlock Text="–û–±–µ—Ä—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç:" FontWeight="Bold" Margin="0,5,0,5" 
                                   Visibility="{Binding IsLeaderView, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                        <ComboBox x:Name="CmbRouteSelect" 
                                  ItemsSource="{Binding PredefinedTrips}"
                                  SelectedItem="{Binding SelectedPredefinedTrip}"
                                  Margin="0,0,0,5" 
                                  Visibility="{Binding IsLeaderView, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel>
                                        <TextBlock Text="{Binding Name}" FontWeight="Bold"/>
                                        <TextBlock Text="{Binding Description}" FontSize="10" Foreground="Gray"/>
                                        <TextBlock Text="‚úÖ –ê–∫—Ç–∏–≤–Ω–∏–π" FontSize="9" Foreground="Green" 
                                                   Visibility="{Binding IsActive, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>

                        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –≤–∏–±—Ä–∞–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É -->
                        <Button x:Name="BtnActivateTrip" Style="{StaticResource PrimaryButton}" 
                                Content="–ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –º–∞—Ä—à—Ä—É—Ç" 
                                Click="BtnActivateTrip_Click"
                                Visibility="{Binding IsLeaderView, Converter={StaticResource BooleanToVisibilityConverter}}"
                                Margin="0,0,0,10"/>

                        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –º–∞—Ä—à—Ä—É—Ç—ñ–≤ -->
                        <Button x:Name="BtnRefreshTrips" Style="{StaticResource SecondaryButton}" 
                                Content="–û–Ω–æ–≤–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç–∏" 
                                Click="BtnRefreshTrips_Click"
                                Visibility="{Binding IsLeaderView, Converter={StaticResource BooleanToVisibilityConverter}}"
                                Margin="0,0,0,10"/>

                        <!-- –ö–Ω–æ–ø–∫–∏ –¥–ª—è –≤—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ -->
                        <Button x:Name="BtnSendHelp" Style="{StaticResource PrimaryButton}" Content="–î–æ–ø–æ–º–æ–≥–∞" Click="BtnSendHelp_Click" Margin="0,5,0,5"/>
                        <Button x:Name="BtnSendStop" Style="{StaticResource SecondaryButton}" Content="–ó—É–ø–∏–Ω–∫–∞" Click="BtnSendStop_Click" Margin="0,5,0,5"/>
                        <Button x:Name="BtnFeedback" Style="{StaticResource SecondaryButton}" Content="–ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫" Click="BtnFeedback_Click" Margin="0,5,0,5"/>

                        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
                        <Button x:Name="BtnEndTrip" Style="{StaticResource SecondaryButton}" Content="–ó–∞–≤–µ—Ä—à–∏—Ç–∏ –ø–æ–¥–æ—Ä–æ–∂" Click="BtnEndTrip_Click" 
                                Visibility="{Binding IsLeaderView, Converter={StaticResource BooleanToVisibilityConverter}}" Margin="0,5,0,5"/>

                        <!-- –ö–Ω–æ–ø–∫–∞ "–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è –ø–æ–¥–æ—Ä–æ–∂—ñ" –ª–∏—à–µ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
                        <Button x:Name="BtnPlanTrip" Style="{StaticResource PrimaryButton}" Content="–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è –ø–æ–¥–æ—Ä–æ–∂—ñ" Click="BtnPlanTrip_Click" 
                                Visibility="{Binding IsLeaderView, Converter={StaticResource BooleanToVisibilityConverter}}" Margin="0,5,0,5"/>

                        <!-- –ö–Ω–æ–ø–∫–∞ –≤–∏—Ö–æ–¥—É -->
                        <Button x:Name="BtnExit" Style="{StaticResource SecondaryButton}" Content="–í–∏—Ö—ñ–¥" Click="BtnExit_Click" Margin="0,5,0,5"/>

                        <!-- –ü–ª–∞–Ω –ø–æ–¥–æ—Ä–æ–∂—ñ –¥–ª—è —É—á–∞—Å–Ω–∏–∫–∞ -->
                        <StackPanel Visibility="{Binding IsParticipantView, Converter={StaticResource BooleanToVisibilityConverter}}" Margin="0,15,0,0">
                            <TextBlock Text="–ü–ª–∞–Ω –ø–æ–¥–æ—Ä–æ–∂—ñ" Style="{StaticResource HeaderText}" Margin="0,0,0,5"/>
                            <TextBlock Text="–ù–∞–∑–≤–∞:" FontWeight="Bold" Margin="0,5,0,0"/>
                            <TextBlock Text="{Binding CurrentTrip.TripName}" Margin="0,0,0,5"/>

                            <TextBlock Text="–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å:" FontWeight="Bold" Margin="0,5,0,0"/>
                            <TextBlock Text="{Binding CurrentTrip.Duration}" Margin="0,0,0,5"/>

                            <TextBlock Text="–ì—Ä–∞—Ñ—ñ–∫ –ø–µ—Ä–µ—Ä–≤:" FontWeight="Bold" Margin="0,5,0,0"/>
                            <TextBlock Text="{Binding CurrentTrip.BreakSchedule}" Margin="0,0,0,5"/>

                            <TextBlock Text="–ú—ñ—Å—Ü—è –≤—ñ–¥–ø–æ—á–∏–Ω–∫—É:" FontWeight="Bold" Margin="0,5,0,0"/>
                            <ItemsControl ItemsSource="{Binding CurrentTrip.RestPlaces}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding}" Margin="0,0,0,2"/>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <TextBlock Text="–¶—ñ–∫–∞–≤—ñ –º—ñ—Å—Ü—è:" FontWeight="Bold" Margin="0,10,0,0"/>
                            <ItemsControl ItemsSource="{Binding CurrentTrip.PointsOfInterest}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding}" Margin="0,0,0,2"/>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>

                        <!-- –°–ø–∏—Å–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –¥–ª—è –∞–¥–º—ñ–Ω–∞ -->
                        <StackPanel Visibility="{Binding IsLeaderView, Converter={StaticResource BooleanToVisibilityConverter}}" Margin="0,15,0,0">
                            <TextBlock Text="–£—Å—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ" Style="{StaticResource HeaderText}" Margin="0,0,0,5"/>
                            <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="250">
                                <ListBox x:Name="UsersListBox" ItemsSource="{Binding Users}" SelectedItem="{Binding SelectedUser}">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal" Margin="4">
                                                <Ellipse Width="12" Height="12" Fill="{Binding IsLeader, Converter={StaticResource BoolToBrushConverter}}" Margin="0,0,8,0"/>
                                                <TextBlock Text="{Binding Name}" VerticalAlignment="Center"/>
                                                <TextBlock Text="{Binding Status}" Foreground="Red" Margin="8,0,0,0" 
                                                           Visibility="{Binding Status, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </ScrollViewer>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </Border>

            <!-- –ö–∞—Ä—Ç–∞: –î–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –≤—Å—ñ—Ö -->
            <Border Grid.Column="1" Margin="8" BorderBrush="LightGray" BorderThickness="1" CornerRadius="6">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Text="{Binding CurrentTrip.TripName}" FontWeight="Bold" Margin="8" VerticalAlignment="Center"/>
                    <gmap:GMapControl x:Name="MapControl" Grid.Row="1" Margin="8"/>
                </Grid>
            </Border>

            <!-- –ü—Ä–∞–≤–∞ –ø–∞–Ω–µ–ª—å: –î–µ—Ç–∞–ª—ñ –¥–ª—è –∞–¥–º—ñ–Ω–∞ –∞–±–æ —Å—Ç–∞—Ç—É—Å –¥–ª—è —É—á–∞—Å–Ω–∏–∫–∞ -->
            <Border Grid.Column="2" Margin="6" BorderBrush="LightGray" BorderThickness="1" CornerRadius="6">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <ScrollViewer Grid.Row="0" VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="10">
                            <StackPanel x:Name="AdminPanel" Visibility="{Binding IsLeaderView, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <TextBlock Text="–î–µ—Ç–∞–ª—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞" Style="{StaticResource HeaderText}" Margin="0,0,0,10"/>

                                <TextBlock Text="–Ü–º'—è:" FontWeight="Bold" Margin="0,5,0,0"/>
                                <TextBlock Text="{Binding SelectedUser.Name}" Margin="0,0,0,5"/>

                                <TextBlock Text="Email:" FontWeight="Bold" Margin="0,5,0,0"/>
                                <TextBlock Text="{Binding SelectedUser.Email}" Margin="0,0,0,5"/>

                                <TextBlock Text="–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏:" FontWeight="Bold" Margin="0,5,0,0"/>
                                <TextBlock Text="{Binding SelectedUser.CurrentLocation}" Margin="0,0,0,5"/>

                                <TextBlock Text="–°—Ç–∞—Ç—É—Å:" FontWeight="Bold" Margin="0,5,0,0"/>
                                <TextBlock Text="{Binding SelectedUser.Status}" Margin="0,0,0,5"/>

                                <Button x:Name="BtnMakeLeader" Style="{StaticResource PrimaryButton}" Content="–ü–æ–∑–Ω–∞—á–∏—Ç–∏ —è–∫ –ª—ñ–¥–µ—Ä–∞" 
                                        Margin="0,10,0,5" Click="BtnMakeLeader_Click"
                                        Visibility="{Binding IsLeaderView, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                                <TextBlock Text="–ú–∞—Ä—à—Ä—É—Ç (—Ç–æ—á–∫–∏)" FontWeight="Bold" FontSize="16" Margin="0,15,0,5"/>
                                <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="120">
                                    <ItemsControl ItemsSource="{Binding CurrentTrip.Route}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding}" Margin="0,0,0,5"/>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>

                                <Button x:Name="BtnClearRoute" Style="{StaticResource SecondaryButton}" Content="–û—á–∏—Å—Ç–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç" 
                                        Margin="0,10,0,5" Click="BtnClearRoute_Click"
                                        Visibility="{Binding IsLeaderView, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                                <TextBlock Text="–û—Å—Ç–∞–Ω–Ω—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è" Style="{StaticResource HeaderText}" Margin="0,15,0,5"/>
                                <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="300">
                                    <ListBox x:Name="NotificationsListBox" ItemsSource="{Binding AllNotifications}" 
                                             Visibility="{Binding ShowNotifications, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <ListBox.ItemTemplate>
                                            <DataTemplate>
                                                <StackPanel Margin="0,5">
                                                    <TextBlock Text="{Binding Time, StringFormat='{}{0:HH:mm:ss}'}" 
                                                               FontSize="11" Foreground="Gray" Margin="0,0,0,2"/>
                                                    <TextBlock Text="{Binding Message}" TextWrapping="Wrap" 
                                                               Margin="0,0,0,5"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </ListBox.ItemTemplate>
                                    </ListBox>
                                </ScrollViewer>
                            </StackPanel>

                            <StackPanel x:Name="UserPanel" Visibility="{Binding IsParticipantView, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <TextBlock Text="–í–∞—à –∞–∫–∞—É–Ω—Ç" Style="{StaticResource HeaderText}" Margin="0,0,0,10"/>
                                <TextBlock Text="–Ü–º'—è:" FontWeight="Bold" Margin="0,5,0,0"/>
                                <TextBlock Text="{Binding CurrentUser.Name}" Margin="0,0,0,5"/>

                                <TextBlock Text="Email:" FontWeight="Bold" Margin="0,5,0,0"/>
                                <TextBlock Text="{Binding CurrentUser.Email}" Margin="0,0,0,5"/>

                                <TextBlock Text="–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏:" FontWeight="Bold" Margin="0,5,0,0"/>
                                <TextBlock Text="{Binding CurrentUser.CurrentLocation}" Margin="0,0,0,5"/>

                                <TextBlock Text="–°—Ç–∞—Ç—É—Å:" FontWeight="Bold" Margin="0,5,0,0"/>
                                <TextBlock Text="{Binding CurrentUser.Status}" Margin="0,0,0,5"/>

                                <TextBlock Text="–í–∞—à—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è" Style="{StaticResource HeaderText}" Margin="0,15,0,5"/>
                                <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="300">
                                    <ListBox x:Name="UserNotificationsListBox" ItemsSource="{Binding UserNotifications}" 
                                             Visibility="{Binding ShowNotifications, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <ListBox.ItemTemplate>
                                            <DataTemplate>
                                                <StackPanel Margin="0,5">
                                                    <TextBlock Text="{Binding Time, StringFormat='{}{0:HH:mm:ss}'}" 
                                                               FontSize="11" Foreground="Gray" Margin="0,0,0,2"/>
                                                    <TextBlock Text="{Binding Message}" TextWrapping="Wrap" 
                                                               Margin="0,0,0,5"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </ListBox.ItemTemplate>
                                    </ListBox>
                                </ScrollViewer>
                            </StackPanel>
                        </StackPanel>
                    </ScrollViewer>

                    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≤–º–∏–∫–∞–Ω–Ω—è/–≤–∏–º–∏–∫–∞–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω—å -->
                    <Button x:Name="BtnToggleNotifications" Grid.Row="1" Content="–í–∏–º–∫–Ω—É—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è" 
                            Style="{StaticResource SecondaryButton}" Width="150" Margin="0,10,10,10" 
                            HorizontalAlignment="Right" Click="BtnToggleNotifications_Click"/>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Window>








-----------------------------------------------------------------------------




MainWindow.xaml.cs
====





using GMap.NET;
using GMap.NET.MapProviders;
using GMap.NET.WindowsPresentation;
using System;
using System.Collections.Generic;
using System.Collections.Specialized;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Shapes;
using System.Threading.Tasks;
using TrackingApp.Models;
using TrackingApp.ViewModels;
using TrackingApp.Services;
using TrackingApp.Config;

namespace TrackingApp.Views
{
    public partial class MainWindow : Window
    {
        private MainViewModel Vm => (MainViewModel)DataContext;
        private GMapRoute _routeMarker;
        private Dictionary<User, GMapMarker> _userMarkers = new Dictionary<User, GMapMarker>();
        private bool _isInitialized = false;

        public MainWindow()
        {
            InitializeComponent();

            InitializeMap();

            Vm.PropertyChanged += Vm_PropertyChanged;
            Vm.Users.CollectionChanged += Users_CollectionChanged;

            if (Vm.CurrentTrip?.Route != null)
            {
                Vm.CurrentTrip.Route.CollectionChanged += Route_CollectionChanged;
            }

            Vm.MapUpdateRequested += () => UpdateMap();

            foreach (var user in Vm.Users)
            {
                user.PropertyChanged += User_PropertyChanged;
            }

            MapControl.MouseLeftButtonDown += MapControl_MouseLeftButtonDown;

            ShowLoginWindow();
        }

        private void ShowLoginWindow()
        {
            var loginWindow = new LoginWindow(Vm);
            loginWindow.ShowDialog();

            if (loginWindow.LoginSuccessful)
            {
                _isInitialized = true;
                UpdateMap();
                System.Diagnostics.Debug.WriteLine("‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞, –æ–Ω–æ–≤–ª—é—î–º–æ –∫–∞—Ä—Ç—É");
            }
            else
            {
                System.Diagnostics.Debug.WriteLine("‚ùå –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –Ω–µ –≤–¥–∞–ª–∞—Å—è, –∑–∞–∫—Ä–∏–≤–∞—î–º–æ –¥–æ–¥–∞—Ç–æ–∫");
                Close();
                return;
            }
        }

        private void InitializeMap()
        {
            try
            {
                GMap.NET.GMaps.Instance.Mode = AccessMode.ServerAndCache;
                MapControl.MapProvider = GMapProviders.OpenStreetMap;
                MapControl.MinZoom = 2;
                MapControl.MaxZoom = 18;
                MapControl.Zoom = 14;
                MapControl.Position = new PointLatLng(49.842957, 24.031111);
                MapControl.ShowCenter = false;
                MapControl.MouseWheelZoomType = MouseWheelZoomType.MousePositionAndCenter;

                System.Diagnostics.Debug.WriteLine("‚úÖ –ö–∞—Ä—Ç–∞ —É—Å–ø—ñ—à–Ω–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –∫–∞—Ä—Ç–∏: {ex.Message}");
                MessageBox.Show($"–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –∫–∞—Ä—Ç–∏: {ex.Message}", "–ü–æ–º–∏–ª–∫–∞", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private async void Window_Loaded(object sender, RoutedEventArgs e)
        {
            await CheckConnectionStatus();
        }

        private void Window_Closing(object sender, System.ComponentModel.CancelEventArgs e)
        {
            Vm.EndTrip();
            System.Diagnostics.Debug.WriteLine("üõë –î–æ–¥–∞—Ç–æ–∫ –∑–∞–∫—Ä–∏–≤–∞—î—Ç—å—Å—è, –∑—É–ø–∏–Ω—è—î–º–æ —Ç–∞–π–º–µ—Ä–∏");
        }

        private async System.Threading.Tasks.Task CheckConnectionStatus()
        {
            if (AppConfig.UseServerMode)
            {
                StatusText.Text = "üîÑ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è...";
                StatusText.Foreground = Brushes.Orange;

                var trackingService = new TrackingService();
                bool isConnected = await trackingService.CheckServerConnectionAsync();

                if (isConnected)
                {
                    StatusText.Text = "‚úÖ –ó'—î–¥–Ω–∞–Ω–æ –∑ —Å–µ—Ä–≤–µ—Ä–æ–º";
                    StatusText.Foreground = Brushes.Green;
                }
                else
                {
                    StatusText.Text = "‚ùå –í—ñ–¥–∫–ª—é—á–µ–Ω–æ –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞";
                    StatusText.Foreground = Brushes.Red;

                    Vm.AddNotification("–£–≤–∞–≥–∞: –Ω–µ–º–∞—î –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º! –î–∞–Ω—ñ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –Ω–µ –∞–∫—Ç—É–∞–ª—å–Ω–∏–º–∏.");
                }
            }
            else
            {
                StatusText.Text = "üîß –õ–æ–∫–∞–ª—å–Ω–∏–π —Ä–µ–∂–∏–º";
                StatusText.Foreground = Brushes.Blue;
            }
        }

        private void User_PropertyChanged(object sender, System.ComponentModel.PropertyChangedEventArgs e)
        {
            if (e.PropertyName == nameof(User.CurrentLocation) || e.PropertyName == nameof(User.Status) || e.PropertyName == nameof(User.IsLeader))
            {
                Application.Current?.Dispatcher?.Invoke(() =>
                {
                    UpdateUserMarker((User)sender);
                });
            }
        }

        private async void MapControl_MouseLeftButtonDown(object sender, MouseButtonEventArgs e)
        {
            if (!Vm.IsLeaderView) return;

            var point = e.GetPosition(MapControl);
            var latLng = MapControl.FromLocalToLatLng((int)point.X, (int)point.Y);
            var newLocation = new TrackingApp.Models.Location(latLng.Lat, latLng.Lng);

            Vm.CurrentTrip.Route.Add(newLocation);
            Vm.AddNotification($"–î–æ–¥–∞–Ω–æ —Ç–æ—á–∫—É –º–∞—Ä—à—Ä—É—Ç—É: {newLocation}");

            await Vm.SaveCurrentTripToServer();

            UpdateMap();
        }

        private void Vm_PropertyChanged(object sender, System.ComponentModel.PropertyChangedEventArgs e)
        {
            if (e.PropertyName == nameof(Vm.CurrentTrip) || e.PropertyName == nameof(Vm.Users) ||
                e.PropertyName == nameof(Vm.ShowNotifications) || e.PropertyName == nameof(Vm.CurrentUser) ||
                e.PropertyName == nameof(Vm.PredefinedTrips) || e.PropertyName == nameof(Vm.SelectedPredefinedTrip))
            {
                UpdateMap();
            }
        }

        private void Users_CollectionChanged(object sender, NotifyCollectionChangedEventArgs e)
        {
            if (e.NewItems != null)
            {
                foreach (User newUser in e.NewItems)
                {
                    newUser.PropertyChanged += User_PropertyChanged;
                }
            }

            if (e.OldItems != null)
            {
                foreach (User oldUser in e.OldItems)
                {
                    oldUser.PropertyChanged -= User_PropertyChanged;
                    if (_userMarkers.ContainsKey(oldUser))
                    {
                        MapControl.Markers.Remove(_userMarkers[oldUser]);
                        _userMarkers.Remove(oldUser);
                    }
                }
            }

            UpdateMap();
        }

        private void Route_CollectionChanged(object sender, NotifyCollectionChangedEventArgs e)
        {
            UpdateMap();
        }

        private void UpdateMap()
        {
            if (!_isInitialized) return;

            try
            {
                Application.Current?.Dispatcher?.Invoke(() =>
                {
                    MapControl.Markers.Clear();
                    _userMarkers.Clear();

                    if (Vm.CurrentTrip?.Route != null)
                    {
                        foreach (var p in Vm.CurrentTrip.Route)
                        {
                            var marker = new GMapMarker(new PointLatLng(p.Latitude, p.Longitude))
                            {
                                Shape = new Ellipse { Width = 8, Height = 8, Fill = Brushes.DarkBlue },
                                Offset = new System.Windows.Point(-4, -4)
                            };
                            MapControl.Markers.Add(marker);
                        }

                        if (Vm.CurrentTrip.Route.Count > 1)
                        {
                            var routePoints = new List<PointLatLng>();
                            foreach (var loc in Vm.CurrentTrip.Route)
                            {
                                routePoints.Add(new PointLatLng(loc.Latitude, loc.Longitude));
                            }

                            if (_routeMarker != null)
                            {
                                MapControl.Markers.Remove(_routeMarker);
                            }

                            _routeMarker = new GMapRoute(routePoints)
                            {
                                Shape = new Path
                                {
                                    Stroke = Brushes.Blue,
                                    StrokeThickness = 3,
                                    Opacity = 0.7
                                }
                            };
                            MapControl.Markers.Add(_routeMarker);
                        }
                    }

                    foreach (var u in Vm.Users)
                    {
                        AddUserMarker(u);
                    }

                    if (Vm.CurrentTrip?.Route != null && Vm.CurrentTrip.Route.Count > 0)
                    {
                        var startPoint = Vm.CurrentTrip.Route[0];
                        MapControl.Position = new PointLatLng(startPoint.Latitude, startPoint.Longitude);
                    }
                });
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏: {ex.Message}");
                Vm.AddNotification($"–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏: {ex.Message}");
            }
        }

        private void AddUserMarker(User user)
        {
            if (user.CurrentLocation == null) return;

            var point = new PointLatLng(user.CurrentLocation.Latitude, user.CurrentLocation.Longitude);

            Brush fillBrush;
            if (user.Status == UserStatus.Help)
            {
                fillBrush = Brushes.Orange;
            }
            else if (user.Status == UserStatus.Stop)
            {
                fillBrush = Brushes.Purple;
            }
            else if (user.IsLeader)
            {
                fillBrush = Brushes.Red;
            }
            else
            {
                fillBrush = Brushes.Green;
            }

            var ellipse = new Ellipse
            {
                Width = 14,
                Height = 14,
                Fill = fillBrush,
                Stroke = Brushes.Black,
                StrokeThickness = 1
            };

            var statusText = user.Status switch
            {
                UserStatus.Help => "‚ùó",
                UserStatus.Stop => "üõë",
                _ => user.IsLeader ? "üëë" : ""
            };

            var textBlock = new TextBlock
            {
                Text = $"{user.Name} {statusText}",
                Foreground = Brushes.Black,
                FontSize = 9,
                FontWeight = FontWeights.Bold,
                Background = Brushes.White,
                Padding = new Thickness(2),
                Opacity = 0.9
            };

            var stackPanel = new StackPanel
            {
                Orientation = Orientation.Vertical,
                Children = { ellipse, textBlock }
            };

            var marker = new GMapMarker(point)
            {
                Shape = stackPanel,
                Offset = new System.Windows.Point(-7, -7)
            };

            MapControl.Markers.Add(marker);
            _userMarkers[user] = marker;
        }

        private void UpdateUserMarker(User user)
        {
            if (_userMarkers.ContainsKey(user))
            {
                var marker = _userMarkers[user];
                marker.Position = new PointLatLng(user.CurrentLocation.Latitude, user.CurrentLocation.Longitude);

                var stackPanel = marker.Shape as StackPanel;
                if (stackPanel != null && stackPanel.Children.Count > 0)
                {
                    var ellipse = stackPanel.Children[0] as Ellipse;
                    var textBlock = stackPanel.Children[1] as TextBlock;

                    if (ellipse != null && textBlock != null)
                    {
                        Brush fillBrush;
                        if (user.Status == UserStatus.Help)
                        {
                            fillBrush = Brushes.Orange;
                        }
                        else if (user.Status == UserStatus.Stop)
                        {
                            fillBrush = Brushes.Purple;
                        }
                        else if (user.IsLeader)
                        {
                            fillBrush = Brushes.Red;
                        }
                        else
                        {
                            fillBrush = Brushes.Green;
                        }
                        ellipse.Fill = fillBrush;

                        var statusText = user.Status switch
                        {
                            UserStatus.Help => "‚ùó",
                            UserStatus.Stop => "üõë",
                            _ => user.IsLeader ? "üëë" : ""
                        };
                        textBlock.Text = $"{user.Name} {statusText}";
                    }
                }
            }
            else
            {
                AddUserMarker(user);
            }
        }

        private async void BtnActivateTrip_Click(object sender, RoutedEventArgs e)
        {
            if (!Vm.IsLeaderView)
            {
                MessageBox.Show("–¢—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ –∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –º–∞—Ä—à—Ä—É—Ç–∏!", "–ü–æ–º–∏–ª–∫–∞", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            if (Vm.SelectedPredefinedTrip == null)
            {
                MessageBox.Show("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç –∑—ñ —Å–ø–∏—Å–∫—É!", "–ü–æ–º–∏–ª–∫–∞", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            try
            {
                System.Diagnostics.Debug.WriteLine($"üéØ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —è–≤–Ω–æ –∞–∫—Ç–∏–≤—É—î –º–∞—Ä—à—Ä—É—Ç: {Vm.SelectedPredefinedTrip.Name}");

                await Vm.SetActiveTripAsync();

                UpdateMap();
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –º–∞—Ä—à—Ä—É—Ç—É: {ex.Message}");
                MessageBox.Show($"–ü–æ–º–∏–ª–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –º–∞—Ä—à—Ä—É—Ç—É: {ex.Message}", "–ü–æ–º–∏–ª–∫–∞", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void CmbRouteSelect_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (!Vm.IsLeaderView || Vm.SelectedPredefinedTrip == null)
                return;

            try
            {
                System.Diagnostics.Debug.WriteLine($"üìã –û–±—Ä–∞–Ω–æ –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É: {Vm.SelectedPredefinedTrip.Name}");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–∏–±–æ—Ä—É –º–∞—Ä—à—Ä—É—Ç—É: {ex.Message}");
            }
        }

        private async void BtnRefreshTrips_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                System.Diagnostics.Debug.WriteLine("üîÑ –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –º–∞—Ä—à—Ä—É—Ç—ñ–≤...");
                await Vm.LoadPredefinedTripsAsync();
                Vm.AddNotification("‚úÖ –°–ø–∏—Å–æ–∫ –º–∞—Ä—à—Ä—É—Ç—ñ–≤ –æ–Ω–æ–≤–ª–µ–Ω–æ");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—ñ–≤: {ex.Message}");
                Vm.AddNotification("‚ùå –ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –º–∞—Ä—à—Ä—É—Ç—ñ–≤");
            }
        }

        private void BtnFeedback_Click(object sender, RoutedEventArgs e)
        {
            var w = new FeedbackWindow(Vm);
            if (w.ShowDialog() == true)
            {
                System.Diagnostics.Debug.WriteLine("‚úÖ –í—ñ–¥–≥—É–∫ —É—Å–ø—ñ—à–Ω–æ –æ–±—Ä–æ–±–ª–µ–Ω–æ");
            }
        }

        private void BtnPlanTrip_Click(object sender, RoutedEventArgs e)
        {
            var planWindow = new PlanTripWindow(Vm);
            if (planWindow.ShowDialog() == true)
            {
                Vm.UpdateTripPlan(planWindow.Duration, planWindow.BreakSchedule, planWindow.RestPlaces, planWindow.PointsOfInterest);
            }
        }

        private void BtnSendHelp_Click(object sender, RoutedEventArgs e)
        {
            if (Vm.CurrentUser != null)
            {
                Vm.SendHelpRequest();
            }
            else
            {
                MessageBox.Show("–ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É!", "–ü–æ–º–∏–ª–∫–∞", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
        }

        private void BtnSendStop_Click(object sender, RoutedEventArgs e)
        {
            if (Vm.CurrentUser != null)
            {
                Vm.SendStopRequest();
            }
            else
            {
                MessageBox.Show("–ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É!", "–ü–æ–º–∏–ª–∫–∞", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
        }

        private void BtnEndTrip_Click(object sender, RoutedEventArgs e)
        {
            if (!Vm.IsLeaderView)
            {
                MessageBox.Show("–¢—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ –∑–∞–≤–µ—Ä—à–∏—Ç–∏ –ø–æ–¥–æ—Ä–æ–∂!", "–ü–æ–º–∏–ª–∫–∞", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            var result = MessageBox.Show("–ß–∏ —Å–ø—Ä–∞–≤–¥—ñ –≤–∏ —Ö–æ—á–µ—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç–∏ –ø–æ–¥–æ—Ä–æ–∂?", "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è",
                MessageBoxButton.YesNo, MessageBoxImage.Question);
            if (result == MessageBoxResult.Yes)
            {
                Vm.EndTrip();
                MessageBox.Show("–ü–æ–¥–æ—Ä–æ–∂ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.", "–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è", MessageBoxButton.OK, MessageBoxImage.Information);
            }
        }

        private void BtnMakeLeader_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                if (Vm.SelectedUser == null)
                {
                    MessageBox.Show("–í–∏–±–µ—Ä—ñ—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞!", "–ü–æ–º–∏–ª–∫–∞", MessageBoxButton.OK, MessageBoxImage.Warning);
                    return;
                }

                foreach (var u in Vm.Users)
                    u.IsLeader = false;

                Vm.SelectedUser.IsLeader = true;
                Vm.SelectedUser.Email = $"{Vm.SelectedUser.Name}@admin.com";

                Vm.AddUser(Vm.SelectedUser);

                Vm.AddNotification($"{Vm.SelectedUser.Name} –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ –ª—ñ–¥–µ—Ä–æ–º");
            }
            catch (Exception ex)
            {
                MessageBox.Show($"–ü–æ–º–∏–ª–∫–∞: {ex.Message}", "–ü–æ–º–∏–ª–∫–∞", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void BtnClearRoute_Click(object sender, RoutedEventArgs e)
        {
            if (!Vm.IsLeaderView)
            {
                MessageBox.Show("–¢—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ –æ—á–∏—â–∞—Ç–∏ –º–∞—Ä—à—Ä—É—Ç!", "–ü–æ–º–∏–ª–∫–∞", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            var result = MessageBox.Show("–ß–∏ —Å–ø—Ä–∞–≤–¥—ñ –≤–∏ —Ö–æ—á–µ—Ç–µ –æ—á–∏—Å—Ç–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç?", "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è",
                MessageBoxButton.YesNo, MessageBoxImage.Question);
            if (result == MessageBoxResult.Yes)
            {
                Vm.ClearRoute();
                UpdateMap();
            }
        }

        private void BtnExit_Click(object sender, RoutedEventArgs e)
        {
            var result = MessageBox.Show("–ß–∏ —Å–ø—Ä–∞–≤–¥—ñ –≤–∏ —Ö–æ—á–µ—Ç–µ –≤–∏–π—Ç–∏?", "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∏—Ö–æ–¥—É",
                MessageBoxButton.YesNo, MessageBoxImage.Question);
            if (result == MessageBoxResult.Yes)
            {
                Vm.CurrentUser = null;
                var loginWindow = new LoginWindow(Vm);
                loginWindow.Show();
                Close();
            }
        }

        private void BtnToggleNotifications_Click(object sender, RoutedEventArgs e)
        {
            Vm.ShowNotifications = !Vm.ShowNotifications;
            BtnToggleNotifications.Content = Vm.ShowNotifications ? "–í–∏–º–∫–Ω—É—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è" : "–£–≤—ñ–º–∫–Ω—É—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è";
        }

        private void BtnDeleteUser_Click(object sender, RoutedEventArgs e)
        {
            if (Vm.SelectedUser == null)
            {
                MessageBox.Show("–í–∏–±–µ—Ä—ñ—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è", "–ü–æ–º–∏–ª–∫–∞", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            if (Vm.SelectedUser.IsLeader)
            {
                MessageBox.Show("–ù–µ –º–æ–∂–Ω–∞ –≤–∏–¥–∞–ª–∏—Ç–∏ –ª—ñ–¥–µ—Ä–∞!", "–ü–æ–º–∏–ª–∫–∞", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            var result = MessageBox.Show($"–í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {Vm.SelectedUser.Name}?",
                                "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è",
                                MessageBoxButton.YesNo,
                                MessageBoxImage.Question);

            if (result == MessageBoxResult.Yes)
            {
                Vm.DeleteUser(Vm.SelectedUser.Name);
            }
        }
    }
}








------------------------------------------------------------------------



PlanTripWindow.xaml
====



<Window x:Class="TrackingApp.Views.PlanTripWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è –ø–æ–¥–æ—Ä–æ–∂—ñ" Height="450" Width="400"
        MinHeight="350" MinWidth="350"
        WindowStartupLocation="CenterScreen">
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <RowDefinition Height="Auto"/>
            <!-- –ü—Ä–æ–º—ñ–∂–æ–∫ -->
            <RowDefinition Height="Auto"/>
            <!-- –ì—Ä–∞—Ñ—ñ–∫ –ø–µ—Ä–µ—Ä–≤: –õ–µ–π–±–ª -->
            <RowDefinition Height="Auto"/>
            <!-- –ì—Ä–∞—Ñ—ñ–∫ –ø–µ—Ä–µ—Ä–≤: –ü–æ–ª–µ -->
            <RowDefinition Height="Auto"/>
            <!-- –ü—Ä–æ–º—ñ–∂–æ–∫ -->
            <RowDefinition Height="Auto"/>
            <!-- –ú—ñ—Å—Ü—è –≤—ñ–¥–ø–æ—á–∏–Ω–∫—É: –õ–µ–π–±–ª -->
            <RowDefinition Height="Auto"/>
            <!-- –ú—ñ—Å—Ü—è –≤—ñ–¥–ø–æ—á–∏–Ω–∫—É: –ü–æ–ª–µ -->
            <RowDefinition Height="Auto"/>
            <!-- –ü—Ä–æ–º—ñ–∂–æ–∫ -->
            <RowDefinition Height="Auto"/>
            <!-- –§–æ—Ç–æ–∑–æ–Ω–∏: –õ–µ–π–±–ª -->
            <RowDefinition Height="Auto"/>
            <!-- –§–æ—Ç–æ–∑–æ–Ω–∏: –ü–æ–ª–µ -->
            <RowDefinition Height="Auto"/>
            <!-- –ü—Ä–æ–º—ñ–∂–æ–∫ -->
            <RowDefinition Height="Auto"/>
            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <RowDefinition Height="*"/>
            <!-- –ó–∞–ø–æ–≤–Ω—é–≤–∞—á -->
        </Grid.RowDefinitions>

        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <TextBlock Grid.Row="0" Text="–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è –ø–æ–¥–æ—Ä–æ–∂—ñ" FontWeight="Bold" FontSize="16" 
                   HorizontalAlignment="Center" Margin="0,0,0,15"/>

        <!-- –ü—Ä–æ–º—ñ–∂–æ–∫ -->
        <Border Grid.Row="1" Height="10"/>

        <!-- –ì—Ä–∞—Ñ—ñ–∫ –ø–µ—Ä–µ—Ä–≤: –õ–µ–π–±–ª -->
        <TextBlock Grid.Row="2" Text="–ì—Ä–∞—Ñ—ñ–∫ –ø–µ—Ä–µ—Ä–≤:" FontWeight="Bold" Margin="0,10,0,5"/>

        <!-- –ì—Ä–∞—Ñ—ñ–∫ –ø–µ—Ä–µ—Ä–≤: –ü–æ–ª–µ -->
        <TextBox Grid.Row="3" x:Name="TxtBreakSchedule" Margin="0,0,0,10" 
                 Text="{Binding CurrentTrip.BreakSchedule, UpdateSourceTrigger=PropertyChanged}" 
                 VerticalContentAlignment="Center" Padding="5" 
                 AcceptsReturn="True" TextWrapping="Wrap"/>

        <!-- –ü—Ä–æ–º—ñ–∂–æ–∫ -->
        <Border Grid.Row="4" Height="10"/>

        <!-- –ú—ñ—Å—Ü—è –≤—ñ–¥–ø–æ—á–∏–Ω–∫—É: –õ–µ–π–±–ª -->
        <TextBlock Grid.Row="5" Text="–ú—ñ—Å—Ü—è –≤—ñ–¥–ø–æ—á–∏–Ω–∫—É (—á–µ—Ä–µ–∑ –∫–æ–º—É):" FontWeight="Bold" Margin="0,10,0,5"/>

        <!-- –ú—ñ—Å—Ü—è –≤—ñ–¥–ø–æ—á–∏–Ω–∫—É: –ü–æ–ª–µ -->
        <TextBox Grid.Row="6" x:Name="TxtRestPlaces" Margin="0,0,0,10" 
                 VerticalContentAlignment="Center" Padding="5" 
                 AcceptsReturn="True" TextWrapping="Wrap"/>

        <!-- –ü—Ä–æ–º—ñ–∂–æ–∫ -->
        <Border Grid.Row="7" Height="10"/>

        <!-- –§–æ—Ç–æ–∑–æ–Ω–∏: –õ–µ–π–±–ª -->
        <TextBlock Grid.Row="8" Text="–§–æ—Ç–æ–∑–æ–Ω–∏ / —ñ—Å—Ç–æ—Ä–∏—á–Ω—ñ –º—ñ—Å—Ü—è (—á–µ—Ä–µ–∑ –∫–æ–º—É):" FontWeight="Bold" Margin="0,10,0,5"/>

        <!-- –§–æ—Ç–æ–∑–æ–Ω–∏: –ü–æ–ª–µ -->
        <TextBox Grid.Row="9" x:Name="TxtPointsOfInterest" Margin="0,0,0,10" 
                 VerticalContentAlignment="Center" Padding="5" 
                 AcceptsReturn="True" TextWrapping="Wrap"/>

        <!-- –ü—Ä–æ–º—ñ–∂–æ–∫ -->
        <Border Grid.Row="10" Height="10"/>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <StackPanel Grid.Row="11" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,0,10">
            <Button x:Name="BtnOk" Click="BtnOk_Click" Width="90" Margin="0,0,8,0">–û–Ω–æ–≤–∏—Ç–∏</Button>
            <Button x:Name="BtnCancel" Click="BtnCancel_Click" Width="90">–í—ñ–¥–º—ñ–Ω–∞</Button>
        </StackPanel>
    </Grid>
</Window>




-----------------------------------------------------------------------------------



PlanTripWindow.xaml.cs
===



using System;
using System.Collections.ObjectModel;
using System.Linq;
using System.Windows;
using TrackingApp.ViewModels;

namespace TrackingApp.Views
{
    public partial class PlanTripWindow : Window
    {
        private readonly MainViewModel _vm;
        public string Duration { get; set; }
        public string BreakSchedule { get; set; }
        public ObservableCollection<string> RestPlaces { get; set; }
        public ObservableCollection<string> PointsOfInterest { get; set; }

        public PlanTripWindow(MainViewModel vm)
        {
            InitializeComponent();
            _vm = vm;
            DataContext = _vm;

            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑–Ω–∞—á–µ–Ω—å
            BreakSchedule = _vm.CurrentTrip.BreakSchedule;
            RestPlaces = new ObservableCollection<string>(_vm.CurrentTrip.RestPlaces);
            PointsOfInterest = new ObservableCollection<string>(_vm.CurrentTrip.PointsOfInterest);

            // –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –ø–æ–ª—ñ–≤ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
            TxtBreakSchedule.Text = BreakSchedule;
            TxtRestPlaces.Text = string.Join(", ", RestPlaces);
            TxtPointsOfInterest.Text = string.Join(", ", PointsOfInterest);

            // –û–±–º–µ–∂–µ–Ω–Ω—è –¥–ª—è –∑–≤–∏—á–∞–π–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            if (!_vm.IsLeaderView)
            {
                MessageBox.Show("–¢—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–ª–∞–Ω –ø–æ–¥–æ—Ä–æ–∂—ñ!");
                TxtBreakSchedule.IsEnabled = false;
                TxtRestPlaces.IsEnabled = false;
                TxtPointsOfInterest.IsEnabled = false;
                BtnOk.IsEnabled = false;
            }
        }

        private void BtnOk_Click(object sender, RoutedEventArgs e)
        {
            if (string.IsNullOrEmpty(TxtBreakSchedule.Text))
            {
                MessageBox.Show("–í–≤–µ–¥—ñ—Ç—å –≥—Ä–∞—Ñ—ñ–∫ –ø–µ—Ä–µ—Ä–≤!");
                return;
            }

            BreakSchedule = TxtBreakSchedule.Text.Trim();
            RestPlaces = new ObservableCollection<string>(TxtRestPlaces.Text.Split(',', StringSplitOptions.RemoveEmptyEntries).Select(s => s.Trim()));
            PointsOfInterest = new ObservableCollection<string>(TxtPointsOfInterest.Text.Split(',', StringSplitOptions.RemoveEmptyEntries).Select(s => s.Trim()));

            DialogResult = true;
            Close();
        }

        private void BtnCancel_Click(object sender, RoutedEventArgs e)
        {
            DialogResult = false;
            Close();
        }
    }
}



-------------------------------------------------------------------------





------------------------------------------------------------------------


App.xaml
===



<Application x:Class="TrackingApp.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             StartupUri="Views/MainWindow.xaml">
    <Application.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Themes/Styles.xaml"/>
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </Application.Resources>
</Application>



----------------------------------------------------------------------



App.xaml.cs
===



using System.Windows;

namespace TrackingApp
{
    public partial class App : Application
    {
    }
}




---------------------------------------------------------------------------




FodyWeavers.xml
===



<Weavers xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="FodyWeavers.xsd">
  <Costura />
</Weavers>


------------------------------------------------------------------------------



-----------------------
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net9.0-windows</TargetFramework>
    <UseWPF>true</UseWPF>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Costura.Fody" Version="6.0.0">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="GMap.NET.Core" Version="2.1.7" />
    <PackageReference Include="GMap.NET.WinPresentation" Version="2.1.7" />
  </ItemGroup>

</Project>
--------------------------


























